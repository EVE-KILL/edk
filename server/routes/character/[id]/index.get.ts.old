import type { H3Event } from 'h3'

export default defineEventHandler(async (event: H3Event) => {
  const characterId = Number.parseInt(getRouterParam(event, 'id') || '0')
  
  if (!characterId) {
    throw createError({
      statusCode: 400,
      statusMessage: 'Invalid character ID'
    })
  }

  // Fetch character info
  let characterInfo = await getCharacterInfo(characterId)
  
  if (!characterInfo) {
    throw createError({
      statusCode: 404,
      statusMessage: 'Character not found'
    })
  }

  // Fetch corporation and alliance data if missing
  if (characterInfo.corporation && !characterInfo.corporation.name?.includes('Corp')) {
    const corpData = await fetchAndStoreCorporation(characterInfo.corporation.id)
    if (corpData) {
      characterInfo.corporation = {
        id: characterInfo.corporation.id,
        name: corpData.name,
        ticker: corpData.ticker
      }
    }
  }

  if (characterInfo.alliance && !characterInfo.alliance.name?.includes('Alliance')) {
    const allianceData = await fetchAndStoreCorporation(characterInfo.alliance.id)
    if (allianceData) {
      characterInfo.alliance = {
        id: characterInfo.alliance.id,
        name: allianceData.name,
        ticker: allianceData.ticker
      }
    }
  }

  // Get pagination parameters
  const query = getQuery(event)
  const page = Math.max(1, Number.parseInt(query.page as string) || 1)
  const perPage = 30
  const offset = (page - 1) * perPage

  // Fetch all data in parallel
  const [shipGroupStats, mostValuableKills, top10Stats, killmailsData, totalKillmails] = await Promise.all([
    getShipGroupStatsByCharacter(characterId),
    getMostValuableKillsByCharacter(characterId, 6),
    getTop10StatsByCharacter(characterId),
    getCharacterKillmails(characterId, perPage, offset, 'all'),
    getCharacterKillmailCount(characterId, 'all')
  ])

  // Calculate pagination
  const totalPages = Math.ceil(totalKillmails / perPage)
  const pagination = {
    currentPage: page,
    totalPages,
    pages: generatePageNumbers(page, totalPages),
    hasPrev: page > 1,
    hasNext: page < totalPages,
    showFirst: page > 3 && totalPages > 5,
    showLast: page < totalPages - 2 && totalPages > 5
  }

  // Split ship group stats into 3 columns
  const shipGroupColumns = []
  const itemsPerColumn = Math.ceil(shipGroupStats.length / 3)
  for (let i = 0; i < 3; i++) {
    shipGroupColumns.push(shipGroupStats.slice(i * itemsPerColumn, (i + 1) * itemsPerColumn))
  }

  // Transform killmail data to match component expectations
  const recentKillmails = killmailsData.map(km => ({
    killmail_id: km.killmail_id,
    victim: {
      ship: {
        type_id: km.victim_ship_type_id,
        name: km.victim_ship_name || 'Unknown Ship',
        group: km.victim_ship_group || 'Unknown'
      },
      character: {
        id: km.victim_character_id,
        name: km.victim_character_name || 'Unknown'
      },
      corporation: {
        id: km.victim_corporation_id,
        name: km.victim_corporation_name || 'Unknown Corp',
        ticker: km.victim_corporation_ticker || '???'
      },
      alliance: km.victim_alliance_id ? {
        id: km.victim_alliance_id,
        name: km.victim_alliance_name || 'Unknown Alliance',
        ticker: km.victim_alliance_ticker || '???'
      } : undefined
    },
    attackers: [{
      character: {
        id: km.attacker_character_id || 0,
        name: km.attacker_character_name || 'Unknown'
      },
      corporation: {
        id: km.attacker_corporation_id || 0,
        name: km.attacker_corporation_name || 'Unknown Corp',
        ticker: km.attacker_corporation_ticker || '???'
      },
      alliance: km.attacker_alliance_id ? {
        id: km.attacker_alliance_id,
        name: km.attacker_alliance_name || 'Unknown Alliance',
        ticker: km.attacker_alliance_ticker || '???'
      } : undefined
    }],
    solar_system: {
      id: km.solar_system_id,
      name: km.solar_system_name || 'Unknown System',
      region: km.region_name || 'Unknown Region'
    },
    ship_value: km.ship_value || 0,
    total_value: km.total_value || 0,
    attacker_count: km.attacker_count || 0,
    killmail_time: timeAgo(new Date(km.killmail_time))
  }))

  // Entity header data
  const entityData = {
    entityId: characterInfo.id,
    entityType: 'character',
    entityName: characterInfo.name,
    ticker: null,
    parent: characterInfo.corporation,
    grandparent: characterInfo.alliance,
    stats: characterInfo.stats,
    baseUrl: `/character/${characterId}`,
    currentTab: 'dashboard'
  }

  // Top 10 stats formatted for the component
  const top10StatsFormatted = {
    ships: top10Stats.ships,
    systems: top10Stats.systems,
    regions: top10Stats.regions,
    corporations: top10Stats.corporations,
    alliances: top10Stats.alliances
  }

  // Render the template
  return render(
    'pages/character-detail',
    {
      title: `${characterInfo.name} - Character`,
      description: `Character statistics for ${characterInfo.name}`,
      keywords: 'eve online, character, killmail, pvp'
    },
    {
      ...entityData,
      shipGroupStats,
      shipGroupColumns,
      mostValuableKills,
      top10Stats: top10StatsFormatted,
      recentKillmails,
      pagination
    }
  )
})

// Helper function to generate page numbers
function generatePageNumbers(currentPage: number, totalPages: number): number[] {
  const pages: number[] = []
  const maxVisible = 5
  
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2))
  let endPage = Math.min(totalPages, startPage + maxVisible - 1)
  
  if (endPage - startPage + 1 < maxVisible) {
    startPage = Math.max(1, endPage - maxVisible + 1)
  }
  
  for (let i = startPage; i <= endPage; i++) {
    pages.push(i)
  }
  
  return pages
}
