<!-- Home Page - EDK Style -->

<!-- Most Valuable Kills - Full Width at Top -->
{{> partials/mostvaluable mostValuableKills=data.mostValuableKills timeRange="Last 7 Days"}}

<!-- Two Column Layout: Sidebar + Killmail List -->
<div style="display: grid; grid-template-columns: minmax(200px, 225px) 1fr; gap: 12px; width: 100%; box-sizing: border-box;">
  <!-- Sidebar: Top 10 Stats -->
  <aside style="min-width: 0;">
    {{> components/top-10-stats stats=data.top10Stats}}
  </aside>

  <!-- Main Content: Killmail List -->
  <section style="min-width: 0;">
    <!-- Pagination Top -->
    {{> partials/pagination pagination=data.pagination baseUrl=data.baseUrl}}

    <!-- Killmail List -->
    {{> partials/killmail-list killmails=data.killmails}}

    <!-- Pagination Bottom -->
    {{> partials/pagination pagination=data.pagination baseUrl=data.baseUrl}}
  </section>
</div>

<script type="module">
  // WebSocket configuration
  const WS_PORT = 3002; // Standalone WebSocket server port
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.hostname}:${WS_PORT}/ws`;
  
  let ws;
  let reconnectInterval = 1000;
  const MAX_RECONNECT_INTERVAL = 30000;

  function connect() {
    console.log('Connecting to WebSocket:', wsUrl);
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log('âœ… WebSocket connected');
      reconnectInterval = 1000; // Reset reconnect interval
      
      // Subscribe to all killmails
      ws.send(JSON.stringify({ type: 'subscribe', topics: ['all'] }));
    };

    ws.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        console.log('ðŸ“¨ Received:', message.type);

        if (message.type === 'subscribed') {
          console.log('âœ… Subscribed to topics:', message.topics);
        } else if (message.type === 'killmail' && message.data) {
          handleNewKillmail(message.data);
        } else if (message.type === 'ping') {
          // Respond to server ping
          ws.send(JSON.stringify({ type: 'pong' }));
        }
      } catch (error) {
        console.error('âŒ Error processing message:', error);
      }
    };

    ws.onclose = (event) => {
      console.log('ðŸ”´ WebSocket disconnected:', event.code, event.reason);
      // Exponential backoff reconnect
      setTimeout(connect, reconnectInterval);
      reconnectInterval = Math.min(reconnectInterval * 2, MAX_RECONNECT_INTERVAL);
    };

    ws.onerror = (error) => {
      console.error('âš ï¸  WebSocket error:', error);
    };
  }

  function handleNewKillmail(killmail) {
    const killmailList = document.querySelector('.kb-kl-list');
    if (!killmailList) return;

    // Create new killmail row
    const killmailRow = document.createElement('div');
    killmailRow.classList.add('kb-kl-row');
    killmailRow.dataset.killmailId = killmail.killmailId;
    killmailRow.onclick = () => {
      window.location.href = `/killmail/${killmail.killmailId}`;
    };
    killmailRow.style.cursor = 'pointer';

    // Format value
    const formattedValue = new Intl.NumberFormat('en-US', { 
      notation: 'compact',
      maximumFractionDigits: 1
    }).format(killmail.totalValue);

    killmailRow.innerHTML = `
      <div class="kb-kl-col kb-kl-col--ship">
        <div class="kb-kl-ship">
          <img src="https://images.evetech.net/types/${killmail.victim.ship.typeId}/icon?size=64" class="kb-kl-ship-icon" alt="${killmail.victim.ship.name}" loading="lazy">
          <div class="kb-kl-info kb-kl-info--ship">
            <div class="kb-kl-info__primary">${killmail.victim.ship.name}</div>
            <div class="kb-kl-info__secondary">${killmail.victim.ship.group}</div>
          </div>
        </div>
      </div>
      <div class="kb-kl-col kb-kl-col--victim">
        <div class="kb-kl-info kb-kl-info--victim">
          <div class="kb-kl-info__primary">
            <a href="/character/${killmail.victim?.character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.victim?.character?.name || 'Unknown'}</a>
          </div>
          <div class="kb-kl-info__secondary">
            <a href="/corporation/${killmail.victim?.corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.corporation?.name || 'Unknown'}</a>
          </div>
          ${killmail.victim.alliance ? `
          <div class="kb-kl-info__secondary">
            <a href="/alliance/${killmail.victim?.alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.alliance?.name || 'Unknown'}</a>
          </div>
          ` : ''}
        </div>
      </div>
      <div class="kb-kl-col kb-kl-col--finalblow">
        <div class="kb-kl-info kb-kl-info--finalblow">
          ${killmail.attackers && killmail.attackers.length > 0 ? `
            <div class="kb-kl-info__primary">
              <a href="/character/${killmail.attackers[0].character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.attackers[0].character?.name || 'Unknown'}</a>
            </div>
            <div class="kb-kl-info__secondary">
              <a href="/corporation/${killmail.attackers[0].corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].corporation?.name || 'Unknown'}</a>
            </div>
            ${killmail.attackers[0].alliance ? `
            <div class="kb-kl-info__secondary">
              <a href="/alliance/${killmail.attackers[0].alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].alliance?.name || 'Unknown'}</a>
            </div>
            ` : ''}
          ` : `
            <div class="kb-kl-info__primary">Unknown</div>
          `}
        </div>
      </div>
      <div class="kb-kl-col kb-kl-col--location">
        <div class="kb-kl-info">
          <div class="kb-kl-info__primary">${killmail.solarSystem.name}</div>
          <div class="kb-kl-info__secondary">${killmail.solarSystem.region}</div>
        </div>
      </div>
      <div class="kb-kl-col kb-kl-col--value">
        <div class="kb-kl-info kb-kl-info--value">
          <div class="kb-kl-value">${formattedValue}</div>
          <div class="kb-kl-info__secondary kb-kl-attackers-count">(${killmail.attackerCount})</div>
        </div>
      </div>
      <div class="kb-kl-col kb-kl-col--time">
        <span class="kb-kl-time">Just now</span>
      </div>
    `;

    // Insert at the top (after header if present)
    const firstChild = killmailList.firstElementChild;
    if (firstChild && firstChild.classList.contains('kb-kl-header')) {
      killmailList.insertBefore(killmailRow, firstChild.nextSibling);
    } else {
      killmailList.insertBefore(killmailRow, killmailList.firstChild);
    }

    // Keep list at max 30 items (+ 1 header)
    const MAX_KILLMAILS = 30;
    if (killmailList.children.length > MAX_KILLMAILS + 1) {
      killmailList.removeChild(killmailList.lastElementChild);
    }

    console.log('âœ… Added killmail to list:', killmail.killmailId);
  }

  // Start connection
  connect();
</script>
