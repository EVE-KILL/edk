<!-- Killmail Detail - EDK Style -->

<!-- Sibling Killmails Navbar -->
{{> partials/killmail-navbar}}

<!-- Two Column Layout -->
<div class="killmail-detail-wrapper">
    <!-- Left Column - Items -->
    <div id="kl-detail-left">

        <!-- Fitting Wheel -->
        <div class="mb-lg">
            {{> partials/fitting-wheel}}
        </div>

        <!-- Items Destroyed/Dropped -->
        <div class="kl-detail-fitting">
            <div style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border-dark); border-radius: 4px; margin-bottom: 20px; overflow: visible; position: relative;">
                <div style="padding: 12px 16px; border-bottom: 1px solid var(--color-border-dark);">
                    <div style="color: var(--color-text-white); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Items Destroyed & Dropped
                    </div>
                </div>

                <div style="padding: 12px 16px;">
                    <table class="kb-table" cellspacing="1" style="width: 100%; background: transparent; border: none; border-spacing: 0;">
                        <tr class="kb-table-header" style="background: transparent;">
                            <td class="kb-table-header" style="text-align: left; padding: 4px 8px; background: transparent; border: none; color: var(--color-text-secondary); font-size: 9px; font-weight: 600; text-transform: uppercase;">Item</td>
                            <td class="kb-table-header" style="text-align: center; width: 50px; padding: 4px 8px; background: transparent; border: none; color: var(--color-text-secondary); font-size: 9px; font-weight: 600; text-transform: uppercase;">Qty</td>
                            <td class="kb-table-header" style="text-align: right; width: 100px; padding: 4px 8px; background: transparent; border: none; color: var(--color-text-secondary); font-size: 9px; font-weight: 600; text-transform: uppercase;">Price</td>
                            <td class="kb-table-header" style="text-align: right; width: 120px; padding: 4px 8px; background: transparent; border: none; color: var(--color-text-secondary); font-size: 9px; font-weight: 600; text-transform: uppercase;">Total ISK</td>
                            <td class="kb-table-header" style="text-align: center; width: 80px; padding: 4px 8px; background: transparent; border: none; color: var(--color-text-secondary); font-size: 9px; font-weight: 600; text-transform: uppercase;">Status</td>
                        </tr>

                        {{#with (prepareItemSections items)}}
                        {{#if this.length}}
                            {{#each this}}
                            <tr class="kb-table-row-even">
                                <td class="kb-table-cell" colspan="5" style="padding: 4px 8px;"><b>{{title}}</b></td>
                            </tr>
                            {{#each items}}
                            {{> partials/item-row}}
                            {{/each}}
                            {{/each}}
                        {{else}}
                            <tr class="kb-table-row-even" style="background: transparent;">
                                <td class="kb-table-cell" colspan="5" style="text-align: center; font-style: italic; color: var(--color-text-secondary); padding: 8px; background: transparent; border: none;">No items destroyed or dropped</td>
                            </tr>
                        {{/if}}
                        {{/with}}

                <!-- Totals Row -->
                <tr class="kb-table-header">
                    <td class="kb-table-cell" colspan="5" style="text-align: left;"><b>TOTALS</b></td>
                </tr>
                <tr class="kb-table-row-odd">
                    <td class="kb-table-cell"><b>Total Destroyed:</b></td>
                    <td class="kb-table-cell" style="text-align: right;" colspan="4">
                        <span class="isk-value">{{formatISK stats.destroyedValue}}</span>
                    </td>
                </tr>
                <tr class="kb-table-row-even">
                    <td class="kb-table-cell"><b>Total Dropped:</b></td>
                    <td class="kb-table-cell" style="text-align: right;" colspan="4">
                        <span class="isk-value">{{formatISK stats.droppedValue}}</span>
                    </td>
                </tr>
                <tr class="kb-table-row-odd">
                    <td class="kb-table-cell"><b>Fit Value:</b></td>
                    <td class="kb-table-cell" style="text-align: right;" colspan="4">
                        <span class="isk-value">{{formatISK stats.fitValue}}</span>
                    </td>
                </tr>
                <tr class="kb-table-row-even">
                    <td class="kb-table-cell"><b>Ship Value:</b></td>
                    <td class="kb-table-cell" style="text-align: right;" colspan="4">
                        <span class="isk-value">{{formatISK stats.shipValue}}</span>
                    </td>
                </tr>
                <tr class="kb-table-row-odd">
                    <td class="kb-table-cell"><b>Total:</b></td>
                    <td class="kb-table-cell" style="text-align: right;" colspan="4">
                        <span class="isk-value">{{formatISK stats.totalValue}}</span>
                    </td>
                </tr>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Right Column - People -->
    <div id="kl-detail-right">

        <!-- Victim Info -->
        <div style="margin-bottom: 10px;">
            {{> partials/killmail-victim-info}}
        </div>

        <!-- Final Blow (only show if more than 1 attacker) -->
        {{#if finalBlow}}
        {{#if (gt attackers.length 1)}}
        <div class="attacker-section">
            <div class="section-title-attackers">Final Blow</div>
            {{#with finalBlow}}
            {{> partials/attacker-card
                character=character
                corporation=corporation
                alliance=alliance
                faction=faction
                ship=ship
                weapon=weapon
                damageDone=damageDone
                damagePercent=(damagePercent damageDone ../totalDamage)
                isFinalBlow=true
            }}
            {{/with}}
        </div>
        {{/if}}
        {{/if}}

        <!-- Top Damage (only show if different from final blow and more than 1 attacker) -->
        {{#if topDamage}}
        {{#if (gt attackers.length 1)}}
        {{#unless (eq topDamage finalBlow)}}
        <div class="attacker-section">
            <div class="section-title-attackers">Top Damage</div>
            {{#with topDamage}}
            {{> partials/attacker-card
                character=character
                corporation=corporation
                alliance=alliance
                faction=faction
                ship=ship
                weapon=weapon
                damageDone=damageDone
                damagePercent=(damagePercent damageDone ../totalDamage)
                isTopDamage=true
            }}
            {{/with}}
        </div>
        {{/unless}}
        {{/if}}
        {{/if}}

        <!-- Involved Parties -->
        {{#if attackers}}
        <div class="attacker-section">
            <div class="section-title-attackers">Involved Parties ({{attackers.length}})</div>
            {{#each attackers}}
            {{> partials/attacker-card
                character=character
                corporation=corporation
                alliance=alliance
                faction=faction
                ship=ship
                weapon=weapon
                damageDone=damageDone
                damagePercent=(damagePercent damageDone ../totalDamage)
                isFinalBlow=finalBlow
                isTopDamage=(eq this ../topDamage)
            }}
            {{#unless @last}}
            <div class="attacker-separator"></div>
            {{/unless}}
            {{/each}}
        </div>
        {{/if}}

    </div>
</div>

<!-- Raw Killmail Link -->
<div style="margin-top: 20px; text-align: center;">
    <a href="#" onclick="ReverseContentDisplay('popup'); return false;" style="color: #9bb3e8;">
        View Raw Killmail
    </a>
    |
    <a href="/api/killmails/{{killmail.killmailId}}" style="color: #9bb3e8;">
        JSON API
    </a>
</div>

<!-- Raw Killmail Popup (hidden by default) -->
<div id="popup" style="display: none;">
    <form>
        <table class="popup-table" style="width: 700px;">
            <tr>
                <td align="center"><strong>Raw Killmail</strong></td>
            </tr>
            <tr>
                <td align="center">
                    <input type="button" value="Close" onClick="ReverseContentDisplay('popup');">
                </td>
            </tr>
            <tr>
                <td valign="top" align="center">
                    <textarea class="killmail" name="killmail" cols="80" rows="30" readonly="readonly">{{rawKillmail}}</textarea>
                </td>
            </tr>
            <tr>
                <td align="center">
                    <input type="button" value="Select All"
                           onClick="this.form.killmail.select(); this.form.killmail.focus(); document.execCommand('Copy')">
                    &nbsp;
                    <input type="button" value="Close" onClick="ReverseContentDisplay('popup');">
                </td>
            </tr>
        </table>
    </form>
</div>
