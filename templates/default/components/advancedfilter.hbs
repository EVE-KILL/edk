{{!--
  Advanced Filter Component

  Usage:
    {{> components/advancedfilter
      baseUrl="/filter"
      filterDefaults=filterDefaults
      pagination=pagination
      filterQueryString=filterQueryString
    }}

  Parameters:
    - baseUrl: Base URL for form submission (required)
    - filterDefaults: Object containing current filter values
    - pagination: Pagination object with currentPage, totalPages, etc.
    - filterQueryString: Current query string for maintaining filters in pagination
--}}

{{#if filterDefaults}}
<script>
// Define critical functions immediately before HTML renders
window.toggleFilterExpanded = window.toggleFilterExpanded || function() {
  const expanded = document.getElementById('advanced-filters-expanded');
  const button = document.getElementById('filter-toggle-btn');
  if (expanded.style.display === 'none' || expanded.style.display === '') {
    expanded.style.display = 'flex';
    button.classList.add('expanded');
  } else {
    expanded.style.display = 'none';
    button.classList.remove('expanded');
  }
};

window.handleTimeRangeChange = window.handleTimeRangeChange || function(select) {
  const customDateRange = document.getElementById('custom-date-range');
  if (select.value === 'custom') {
    customDateRange.style.display = 'flex';
  } else {
    customDateRange.style.display = 'none';
  }
};

window.handleTimeRangeChange = window.handleTimeRangeChange || function(select) {
  const customDateRange = document.getElementById('custom-date-range');
  if (select.value === 'custom') {
    customDateRange.style.display = 'flex';
  } else {
    customDateRange.style.display = 'none';
  }
};
</script>
<form id="advanced-filters-form" class="advanced-filters" method="get" action="{{baseUrl}}">
  <!-- Header with Title and Actions -->
  <div class="advanced-filters__header">
    <div class="advanced-filters__title">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
      Advanced Filters
    </div>
    <div class="advanced-filters__actions">
      <button type="button" onclick="toggleFilterExpanded()" class="advanced-filters__toggle-btn" id="filter-toggle-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="expand-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
      </button>
      <button type="button" class="advanced-filters__apply-header" onclick="submitAdvancedFilters()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Apply Filters
      </button>
      <a href="{{baseUrl}}" class="advanced-filters__reset">Reset All</a>
    </div>
  </div>

  <!-- Expanded Filter Controls -->
  <div class="advanced-filters__expanded" id="advanced-filters-expanded" style="display: {{#if filterDefaults.hasActiveFilters}}none{{else}}flex{{/if}};">

    <!-- Entity Search Bar -->
    <div class="advanced-filters__search-section">
      <h4 class="advanced-filters__section-title">Search for Entities or Items</h4>
      <div class="advanced-filters__search-wrapper">
        <input
          type="text"
          id="entity-search-input"
          class="advanced-filters__search-input"
          placeholder="Search for characters, corporations, alliances, systems, or items..."
          autocomplete="off"
        />
        <div id="entity-search-results" class="advanced-filters__search-results"></div>
      </div>
      <div class="advanced-filters__search-hint">
        <small>Click on a result to add it to a filter column below</small>
      </div>
    </div>

    <!-- Entity Filters (Victim/Both/Attacker columns) -->
    <div class="advanced-filters__entity-section">
      <h4 class="advanced-filters__section-title">Entity Filters</h4>
      <p class="advanced-filters__section-description">Add entities to filter killmails by victim, attacker, or both roles</p>
      <div class="advanced-filters__entity-columns">
        <!-- Victim Column -->
        <div class="advanced-filters__entity-column" data-role="victim">
          <div class="advanced-filters__entity-header" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
            <span class="advanced-filters__entity-title" style="color: #ef4444;">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              Victim
            </span>
          </div>
          <div class="advanced-filters__entity-list" id="victim-entities" data-role="victim">
            <div class="advanced-filters__empty-state">No victims added</div>
          </div>
        </div>

        <!-- Both Column -->
        <div class="advanced-filters__entity-column" data-role="both">
          <div class="advanced-filters__entity-header" style="background: rgba(34, 197, 94, 0.1); border-color: #22c55e;">
            <span class="advanced-filters__entity-title" style="color: #22c55e;">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Both
            </span>
          </div>
          <div class="advanced-filters__entity-list" id="both-entities" data-role="both">
            <div class="advanced-filters__empty-state">No entities added</div>
          </div>
        </div>

        <!-- Attacker Column -->
        <div class="advanced-filters__entity-column" data-role="attacker">
          <div class="advanced-filters__entity-header" style="background: rgba(59, 130, 246, 0.1); border-color: #3b82f6;">
            <span class="advanced-filters__entity-title" style="color: #3b82f6;">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
              </svg>
              Attacker
            </span>
          </div>
          <div class="advanced-filters__entity-list" id="attacker-entities" data-role="attacker">
            <div class="advanced-filters__empty-state">No attackers added</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Filters -->
    <div class="advanced-filters__location-section">
      <h4 class="advanced-filters__section-title">Location Filters</h4>
      <p class="advanced-filters__section-description">Filter by solar system, constellation, or region</p>
      <div class="advanced-filters__location-list" id="location-filters">
        <div class="advanced-filters__empty-state">No locations added</div>
      </div>
    </div>

    <!-- Item Filters -->
    <div class="advanced-filters__item-section">
      <h4 class="advanced-filters__section-title">Item Filters</h4>
      <p class="advanced-filters__section-description">Filter by items that must be present on killmails</p>
      <div class="advanced-filters__item-list" id="item-filters">
        <div class="advanced-filters__empty-state">No items added</div>
      </div>
    </div>

  </div>

  <!-- Quick Filter Controls (Always Visible) -->
  <div class="advanced-filters__quick">
    <select name="minTotalValue" class="advanced-filters__select">
      <option value="">Value: Any</option>
      <option value="100000000" {{#if (eq filterDefaults.minTotalValue 100000000)}}selected{{/if}}>Value: 100M+</option>
      <option value="500000000" {{#if (eq filterDefaults.minTotalValue 500000000)}}selected{{/if}}>Value: 500M+</option>
      <option value="1000000000" {{#if (eq filterDefaults.minTotalValue 1000000000)}}selected{{/if}}>Value: 1B+</option>
      <option value="2000000000" {{#if (eq filterDefaults.minTotalValue 2000000000)}}selected{{/if}}>Value: 2B+</option>
      <option value="5000000000" {{#if (eq filterDefaults.minTotalValue 5000000000)}}selected{{/if}}>Value: 5B+</option>
      <option value="10000000000" {{#if (eq filterDefaults.minTotalValue 10000000000)}}selected{{/if}}>Value: 10B+</option>
      <option value="50000000000" {{#if (eq filterDefaults.minTotalValue 50000000000)}}selected{{/if}}>Value: 50B+</option>
      <option value="100000000000" {{#if (eq filterDefaults.minTotalValue 100000000000)}}selected{{/if}}>Value: 100B+</option>
    </select>

    <select name="securityStatus" class="advanced-filters__select">
      <option value="">Security: Any</option>
      <option value="highsec" {{#if (eq filterDefaults.securityStatus "highsec")}}selected{{/if}}>Security: High Sec</option>
      <option value="lowsec" {{#if (eq filterDefaults.securityStatus "lowsec")}}selected{{/if}}>Security: Low Sec</option>
      <option value="nullsec" {{#if (eq filterDefaults.securityStatus "nullsec")}}selected{{/if}}>Security: Null Sec</option>
      <option value="wormhole" {{#if (eq filterDefaults.securityStatus "wormhole")}}selected{{/if}}>Security: Wormhole</option>
      <option value="abyssal" {{#if (eq filterDefaults.securityStatus "abyssal")}}selected{{/if}}>Security: Abyssal</option>
      <option value="pochven" {{#if (eq filterDefaults.securityStatus "pochven")}}selected{{/if}}>Security: Pochven</option>
    </select>

    <select name="shipClass" class="advanced-filters__select">
      <option value="">Ship Class: Any</option>
      <option value="frigate" {{#if (eq filterDefaults.shipClass "frigate")}}selected{{/if}}>Frigate</option>
      <option value="destroyer" {{#if (eq filterDefaults.shipClass "destroyer")}}selected{{/if}}>Destroyer</option>
      <option value="cruiser" {{#if (eq filterDefaults.shipClass "cruiser")}}selected{{/if}}>Cruiser</option>
      <option value="battlecruiser" {{#if (eq filterDefaults.shipClass "battlecruiser")}}selected{{/if}}>Battlecruiser</option>
      <option value="battleship" {{#if (eq filterDefaults.shipClass "battleship")}}selected{{/if}}>Battleship</option>
      <option value="carrier" {{#if (eq filterDefaults.shipClass "carrier")}}selected{{/if}}>Carrier</option>
      <option value="dreadnought" {{#if (eq filterDefaults.shipClass "dreadnought")}}selected{{/if}}>Dreadnought</option>
      <option value="supercarrier" {{#if (eq filterDefaults.shipClass "supercarrier")}}selected{{/if}}>Supercarrier</option>
      <option value="titan" {{#if (eq filterDefaults.shipClass "titan")}}selected{{/if}}>Titan</option>
      <option value="freighter" {{#if (eq filterDefaults.shipClass "freighter")}}selected{{/if}}>Freighter</option>
      <option value="industrial" {{#if (eq filterDefaults.shipClass "industrial")}}selected{{/if}}>Industrial</option>
      <option value="structure" {{#if (eq filterDefaults.shipClass "structure")}}selected{{/if}}>Structure</option>
    </select>

    <select name="techLevel" class="advanced-filters__select">
      <option value="">Tech: Any</option>
      <option value="t1" {{#if (eq filterDefaults.techLevel "t1")}}selected{{/if}}>Tech: T1</option>
      <option value="t2" {{#if (eq filterDefaults.techLevel "t2")}}selected{{/if}}>Tech: T2</option>
      <option value="t3" {{#if (eq filterDefaults.techLevel "t3")}}selected{{/if}}>Tech: T3</option>
      <option value="faction" {{#if (eq filterDefaults.techLevel "faction")}}selected{{/if}}>Tech: Faction</option>
    </select>

    <select name="killTypeSelect" class="advanced-filters__select" onchange="updateAdvancedKillTypeInputs(this)">
      <option value="">Kill Type: Any</option>
      <option value="solo" {{#if filterDefaults.isSolo}}selected{{/if}}>Kill Type: Solo</option>
      <option value="awox" {{#if filterDefaults.isAwox}}selected{{/if}}>Kill Type: Awox</option>
      <option value="npc" {{#if filterDefaults.isNpc}}selected{{/if}}>Kill Type: NPC</option>
    </select>
    <input type="hidden" name="solo" value="{{#if filterDefaults.isSolo}}1{{/if}}" id="advanced-filter-solo" />
    <input type="hidden" name="awox" value="{{#if filterDefaults.isAwox}}1{{/if}}" id="advanced-filter-awox" />
    <input type="hidden" name="npc" value="{{#if filterDefaults.isNpc}}1{{/if}}" id="advanced-filter-npc" />

    <select name="attackerCount" class="advanced-filters__select">
      <option value="">Attackers: Any</option>
      <option value="solo" {{#if (eq filterDefaults.attackerCount "solo")}}selected{{/if}}>Attackers: Solo (1)</option>
      <option value="small" {{#if (eq filterDefaults.attackerCount "small")}}selected{{/if}}>Attackers: Small (2-5)</option>
      <option value="medium" {{#if (eq filterDefaults.attackerCount "medium")}}selected{{/if}}>Attackers: Medium (6-15)</option>
      <option value="large" {{#if (eq filterDefaults.attackerCount "large")}}selected{{/if}}>Attackers: Large (16-50)</option>
      <option value="fleet" {{#if (eq filterDefaults.attackerCount "fleet")}}selected{{/if}}>Attackers: Fleet (51+)</option>
    </select>

    <select name="timeRange" class="advanced-filters__select" onchange="handleTimeRangeChange(this)">
      <option value="">Time: All Time</option>
      <option value="today" {{#if (eq filterDefaults.timeRange "today")}}selected{{/if}}>Time: Today</option>
      <option value="yesterday" {{#if (eq filterDefaults.timeRange "yesterday")}}selected{{/if}}>Time: Yesterday</option>
      <option value="last7days" {{#if (eq filterDefaults.timeRange "last7days")}}selected{{/if}}>Time: Last 7 Days</option>
      <option value="thisweek" {{#if (eq filterDefaults.timeRange "thisweek")}}selected{{/if}}>Time: This Week</option>
      <option value="last30days" {{#if (eq filterDefaults.timeRange "last30days")}}selected{{/if}}>Time: Last 30 Days</option>
      <option value="thismonth" {{#if (eq filterDefaults.timeRange "thismonth")}}selected{{/if}}>Time: This Month</option>
      <option value="custom" {{#if (eq filterDefaults.timeRange "custom")}}selected{{/if}}>Time: Custom Range</option>
    </select>

    <label class="advanced-filters__toggle">
      <input type="checkbox" id="advanced-filter-capsules-checkbox" {{#unless filterDefaults.noCapsules}}checked{{/unless}} onchange="toggleAdvancedCapsules(this)">
      <span class="advanced-filters__toggle-text">Capsules</span>
    </label>
    {{#if filterDefaults.noCapsules}}
    <input type="hidden" name="noCapsules" value="1" id="advanced-filter-capsules-hidden">
    {{/if}}
  </div>

  <!-- Custom Date Range Row (shown when timeRange=custom) -->
  <div id="custom-date-range" class="advanced-filters__custom-dates" style="display: {{#if (eq filterDefaults.timeRange "custom")}}flex{{else}}none{{/if}};">
    <label style="color: var(--color-text-secondary); font-size: 11px; min-width: 40px;">From:</label>
    <input type="datetime-local" name="killTimeFrom" class="advanced-filters__select" style="flex: 1; max-width: 200px;" value="{{filterDefaults.killTimeFrom}}" placeholder="From" />
    <label style="color: var(--color-text-secondary); font-size: 11px; min-width: 30px; text-align: center;">To:</label>
    <input type="datetime-local" name="killTimeTo" class="advanced-filters__select" style="flex: 1; max-width: 200px;" value="{{filterDefaults.killTimeTo}}" placeholder="To" />
  </div>
</form>

<style>
.advanced-filters {
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  margin-bottom: var(--spacing-lg);
  display: flex;
  flex-direction: column;
}

.advanced-filters__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  border-bottom: 1px solid var(--color-border-dark);
  background: rgba(0, 0, 0, 0.2);
}

.advanced-filters__title {
  font-size: 11px;
  font-weight: 700;
  color: var(--color-text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.advanced-filters__actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.advanced-filters__toggle-btn {
  background: transparent;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  transition: color 0.2s ease, transform 0.2s ease;
}

.advanced-filters__toggle-btn:hover {
  color: var(--color-accent-blue);
}

.advanced-filters__toggle-btn.expanded svg {
  transform: rotate(180deg);
}

.advanced-filters__reset {
  font-size: 10px;
  color: var(--color-text-tertiary);
  text-decoration: none;
  transition: color 0.2s ease;
  padding: 4px 8px;
}

.advanced-filters__reset:hover {
  color: var(--color-accent-blue);
  text-decoration: underline;
}

/* Expanded Section */
.advanced-filters__expanded {
  padding: 16px;
  background: rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid var(--color-border-dark);
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.advanced-filters__section-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--color-text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0 0 10px 0;
}

.advanced-filters__section-description {
  font-size: 10px;
  color: var(--color-text-tertiary);
  margin: -5px 0 10px 0;
}

/* Search Section */
.advanced-filters__search-section {
  position: relative;
}

.advanced-filters__search-wrapper {
  position: relative;
}

.advanced-filters__search-input {
  width: 100%;
  padding: 10px 12px;
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  color: var(--color-text-light);
  font-size: 12px;
  transition: border-color 0.2s ease;
}

.advanced-filters__search-input:focus {
  outline: none;
  border-color: var(--color-accent-blue);
  box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.1);
}

.advanced-filters__search-hint {
  margin-top: 6px;
  font-size: 10px;
  color: var(--color-text-tertiary);
  font-style: italic;
}

.advanced-filters__search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 4px;
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.advanced-filters__search-results:empty {
  display: none;
}

.advanced-filters__search-group {
  border-bottom: 1px solid var(--color-border-dark);
}

.advanced-filters__search-group:last-child {
  border-bottom: none;
}

.advanced-filters__search-group-title {
  padding: 8px 12px;
  font-size: 10px;
  font-weight: 600;
  color: var(--color-text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: rgba(0, 0, 0, 0.2);
}

.advanced-filters__search-item {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 11px;
  color: var(--color-text-light);
  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  transition: background 0.2s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.advanced-filters__search-item:hover {
  background: rgba(74, 158, 255, 0.1);
}

.advanced-filters__search-item-name {
  flex: 1;
}

.advanced-filters__search-item-type {
  font-size: 9px;
  color: var(--color-text-tertiary);
  text-transform: capitalize;
}

/* Entity Columns */
.advanced-filters__entity-section {

}

.advanced-filters__entity-columns {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

@media (max-width: 900px) {
  .advanced-filters__entity-columns {
    grid-template-columns: 1fr;
  }
}

.advanced-filters__entity-column {
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.advanced-filters__entity-header {
  padding: 8px 12px;
  border-bottom: 1px solid;
}

.advanced-filters__entity-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.advanced-filters__entity-list {
  padding: 8px;
  min-height: 100px;
  max-height: 300px;
  overflow-y: auto;
}

.advanced-filters__entity-list.drag-over {
  background: rgba(74, 158, 255, 0.1);
  border-color: var(--color-accent-blue);
}

.advanced-filters__empty-state {
  padding: 20px;
  text-align: center;
  font-size: 10px;
  color: var(--color-text-tertiary);
  font-style: italic;
}

.advanced-filters__entity-chip {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 6px 10px;
  margin-bottom: 6px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: var(--radius-sm);
  font-size: 11px;
  color: var(--color-text-light);
  cursor: move;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.advanced-filters__entity-chip:hover {
  opacity: 0.8;
}

.advanced-filters__entity-chip.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.advanced-filters__entity-chip-info {
  flex: 1;
  overflow: hidden;
}

.advanced-filters__entity-chip-name {
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.advanced-filters__entity-chip-type {
  font-size: 9px;
  color: var(--color-text-tertiary);
  text-transform: capitalize;
}

.advanced-filters__entity-chip-remove {
  background: transparent;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  display: flex;
  align-items: center;
  transition: color 0.2s ease;
  flex-shrink: 0;
}

.advanced-filters__entity-chip-remove:hover {
  color: #ef4444;
}

/* Location and Item Filters */
.advanced-filters__location-section,
.advanced-filters__item-section {
  margin-top: 20px;
}

.advanced-filters__location-list,
.advanced-filters__item-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  padding: 12px;
  min-height: 80px;
}

.advanced-filters__location-chip,
.advanced-filters__item-chip {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: var(--radius-sm);
  font-size: 11px;
  color: var(--color-text-white);
  transition: opacity 0.2s ease;
}

.advanced-filters__location-chip:hover,
.advanced-filters__item-chip:hover {
  opacity: 0.8;
}

.advanced-filters__location-chip-name,
.advanced-filters__item-chip-name {
  font-weight: 500;
}

.advanced-filters__location-chip-type,
.advanced-filters__item-chip-type {
  font-size: 9px;
  color: var(--color-text-tertiary);
  text-transform: capitalize;
}

.advanced-filters__location-chip-remove,
.advanced-filters__item-chip-remove {
  background: transparent;
  border: none;
  color: var(--color-text-tertiary);
  cursor: pointer;
  padding: 2px;
  display: flex;
  align-items: center;
  transition: color 0.2s ease;
  flex-shrink: 0;
}

.advanced-filters__location-chip-remove:hover,
.advanced-filters__item-chip-remove:hover {
  color: #ef4444;
}

/* Quick Filters */
.advanced-filters__quick {
  padding: 8px 10px;
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  align-items: center;
  gap: 6px;
  overflow-x: auto;
}

@media (max-width: 900px) {
  .advanced-filters__quick {
    flex-wrap: wrap;
  }
}

.advanced-filters__select {
  background-color: var(--color-bg-tertiary) !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 6px center;
  border: 1px solid var(--color-border-dark);
  color: var(--color-text-secondary) !important;
  padding: 5px 6px;
  padding-right: 22px;
  border-radius: var(--radius-sm);
  font-size: 10px;
  font-weight: 500;
  cursor: pointer;
  transition: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  min-width: 105px;
  max-width: 125px;
  flex-shrink: 1;
}

.advanced-filters__select option {
  background-color: var(--color-bg-tertiary) !important;
  color: var(--color-text-secondary) !important;
}

.advanced-filters__select:hover {
  border-color: var(--color-accent-blue);
  background-color: rgba(74, 158, 255, 0.05) !important;
  color: var(--color-text-white) !important;
}

.advanced-filters__select:focus {
  outline: none;
  border-color: var(--color-accent-blue);
  background-color: var(--color-bg-tertiary) !important;
  box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.1);
  color: var(--color-text-white) !important;
}

.advanced-filters__toggle {
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  user-select: none;
  padding: 5px 8px;
  border: 1px solid var(--color-border-dark);
  background: var(--color-bg-tertiary);
  border-radius: var(--radius-sm);
  transition: all 0.2s ease;
  white-space: nowrap;
}

.advanced-filters__toggle:hover {
  border-color: var(--color-accent-blue);
  background-color: rgba(74, 158, 255, 0.05);
}

.advanced-filters__toggle input[type="checkbox"] {
  margin: 0;
  cursor: pointer;
}

.advanced-filters__toggle-text {
  font-size: 10px;
  font-weight: 500;
  color: var(--color-text-secondary);
}

.advanced-filters__apply-header {
  padding: 4px 10px;
  background: var(--color-accent-blue);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}

.advanced-filters__apply-header:hover {
  background: #5a9eff;
}

.advanced-filters__apply-header:active {
  background: #3d7dd6;
}

.advanced-filters__custom-dates {
  padding: 8px 12px;
  gap: 12px;
  align-items: center;
  border-top: 1px solid var(--color-border-dark);
  background: rgba(0, 0, 0, 0.15);
}
</style>

<script>
// Entity storage
let entityFilters = {
  victim: [],
  both: [],
  attacker: []
};

// Location and item storage
let locationFilters = [];
let itemFilters = [];

// Search debounce
let searchTimeout = null;

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Toggle expanded section
window.toggleFilterExpanded = function() {
  const expanded = document.getElementById('advanced-filters-expanded');
  const button = document.getElementById('filter-toggle-btn');
  const icon = document.getElementById('expand-icon');

  if (expanded.style.display === 'none' || expanded.style.display === '') {
    expanded.style.display = 'flex';
    button.classList.add('expanded');
  } else {
    expanded.style.display = 'none';
    button.classList.remove('expanded');
  }
};

// Initialize button state on load
document.addEventListener('DOMContentLoaded', function() {
  const expanded = document.getElementById('advanced-filters-expanded');
  const button = document.getElementById('filter-toggle-btn');

  if (expanded && button) {
    if (expanded.style.display === 'flex') {
      button.classList.add('expanded');
    }
  }
});

// Entity search
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('entity-search-input');
  const searchResults = document.getElementById('entity-search-results');

  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();

      clearTimeout(searchTimeout);

      if (query.length < 2) {
        searchResults.innerHTML = '';
        searchResults.style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(() => {
        performEntitySearch(query);
      }, 300);
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.advanced-filters__search-wrapper')) {
        searchResults.style.display = 'none';
      }
    });
  }
});

async function performEntitySearch(query) {
  const searchResults = document.getElementById('entity-search-results');

  try {
    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=5`);
    const data = await response.json();

    if (!data.results || data.results.length === 0) {
      searchResults.innerHTML = '<div class="advanced-filters__search-item" style="cursor: default; padding: 12px;">No results found</div>';
      searchResults.style.display = 'block';
      return;
    }

    // Group results by type
    const grouped = {};
    data.results.forEach(result => {
      if (!grouped[result.type]) {
        grouped[result.type] = [];
      }
      grouped[result.type].push(result);
    });

    // Filter out already added entities, locations, and items
    const allAddedEntities = [
      ...entityFilters.victim,
      ...entityFilters.both,
      ...entityFilters.attacker
    ];
    const allAddedLocations = [...locationFilters];
    const allAddedItems = [...itemFilters];

    // Render grouped results
    let html = '';
    for (const type in grouped) {
      const filteredResults = grouped[type].filter(result => {
        // Check locations
        if (['system', 'constellation', 'region'].includes(result.type)) {
          return !allAddedLocations.some(added =>
            Number(added.id) === Number(result.id) &&
            String(added.type) === String(result.type)
          );
        }

        // Check items
        if (result.type === 'item') {
          return !allAddedItems.some(added =>
            Number(added.id) === Number(result.id)
          );
        }

        // Check entities (character, corporation, alliance)
        return !allAddedEntities.some(added =>
          Number(added.id) === Number(result.id) &&
          String(added.type) === String(result.type)
        );
      });

      // Skip empty groups
      if (filteredResults.length === 0) continue;

      html += `<div class="advanced-filters__search-group">`;
      html += `<div class="advanced-filters__search-group-title">${type}s</div>`;
      filteredResults.forEach(result => {
        const showTicker = (result.type === 'corporation' || result.type === 'alliance') && result.ticker;
        const ticker = showTicker ? ` &lt;${escapeHtml(result.ticker)}&gt;` : '';
        const displayName = escapeHtml(result.name) + ticker;

        // Determine which handler to use based on type
        const isLocation = ['system', 'constellation', 'region'].includes(result.type);
        const isItem = result.type === 'item';
        const handler = isLocation ? 'addLocationFilter' : isItem ? 'addItemFilter' : 'showEntityRoleSelector';
        const params = isLocation || isItem
          ? `${result.id}, '${escapeHtml(result.name)}', '${result.type}'`
          : `${result.id}, '${escapeHtml(result.name)}', '${result.type}', '${escapeHtml(result.ticker || '')}'`;

        html += `<div class="advanced-filters__search-item" onclick="${handler}(${params})">`;
        html += `<span class="advanced-filters__search-item-name">${displayName}</span>`;
        html += `<span class="advanced-filters__search-item-type">${result.type}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }

    // Show "no results" if all were filtered out
    if (!html) {
      html = '<div class="advanced-filters__search-item" style="cursor: default; padding: 12px;">All matching entities already added</div>';
    }

    searchResults.innerHTML = html;
    searchResults.style.display = 'block';
  } catch (error) {
    console.error('Search error:', error);
    searchResults.innerHTML = '<div class="advanced-filters__search-item" style="cursor: default; padding: 12px; color: #ef4444;">Search failed</div>';
    searchResults.style.display = 'block';
  }
}

window.showEntityRoleSelector = function(entityId, entityName, entityType, entityTicker) {
  // Add to 'both' by default
  const entity = {
    id: entityId,
    name: entityName,
    type: entityType,
    ticker: entityTicker || null
  };
  addEntityToRole(entity, 'both');

  // Clear search
  document.getElementById('entity-search-input').value = '';
  document.getElementById('entity-search-results').style.display = 'none';
};

function addEntityToRole(entity, role) {
  // Check if already exists
  const exists = entityFilters[role].some(e =>
    Number(e.id) === Number(entity.id) && String(e.type) === String(entity.type)
  );
  if (exists) {
    return;
  }

  entityFilters[role].push(entity);
  renderEntityList(role);
}

window.removeEntityFromRole = function(entityId, entityType, role) {
  entityFilters[role] = entityFilters[role].filter(e =>
    !(Number(e.id) === Number(entityId) && String(e.type) === String(entityType))
  );
  renderEntityList(role);
};

// Location filter handlers
window.addLocationFilter = function(locationId, locationName, locationType) {
  const location = {
    id: locationId,
    name: locationName,
    type: locationType
  };

  // Check if already exists
  const exists = locationFilters.some(l =>
    Number(l.id) === Number(locationId) && String(l.type) === String(locationType)
  );
  if (exists) {
    return;
  }

  locationFilters.push(location);
  renderLocationList();

  // Clear search
  document.getElementById('entity-search-input').value = '';
  document.getElementById('entity-search-results').style.display = 'none';
};

window.removeLocationFilter = function(locationId, locationType) {
  locationFilters = locationFilters.filter(l =>
    !(Number(l.id) === Number(locationId) && String(l.type) === String(locationType))
  );
  renderLocationList();
};

function renderLocationList() {
  const container = document.getElementById('location-filters');

  if (locationFilters.length === 0) {
    container.innerHTML = '<div class="advanced-filters__empty-state">No locations added</div>';
    return;
  }

  let html = '';
  locationFilters.forEach(location => {
    html += `<div class="advanced-filters__location-chip">`;
    html += `<div>`;
    html += `<div class="advanced-filters__location-chip-name">${escapeHtml(location.name)}</div>`;
    html += `<div class="advanced-filters__location-chip-type">${location.type}</div>`;
    html += `</div>`;
    html += `<button type="button" class="advanced-filters__location-chip-remove" onclick="removeLocationFilter(${location.id}, '${location.type}')">`;
    html += `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    html += `</button>`;
    html += `</div>`;
  });

  container.innerHTML = html;
}

// Item filter handlers
window.addItemFilter = function(itemId, itemName, itemType) {
  const item = {
    id: itemId,
    name: itemName,
    type: itemType
  };

  // Check if already exists
  const exists = itemFilters.some(i =>
    Number(i.id) === Number(itemId)
  );
  if (exists) {
    return;
  }

  itemFilters.push(item);
  renderItemList();

  // Clear search
  document.getElementById('entity-search-input').value = '';
  document.getElementById('entity-search-results').style.display = 'none';
};

window.removeItemFilter = function(itemId) {
  itemFilters = itemFilters.filter(i =>
    Number(i.id) !== Number(itemId)
  );
  renderItemList();
};

function renderItemList() {
  const container = document.getElementById('item-filters');

  if (itemFilters.length === 0) {
    container.innerHTML = '<div class="advanced-filters__empty-state">No items added</div>';
    return;
  }

  let html = '';
  itemFilters.forEach(item => {
    html += `<div class="advanced-filters__item-chip">`;
    html += `<div class="advanced-filters__item-chip-name">${escapeHtml(item.name)}</div>`;
    html += `<button type="button" class="advanced-filters__item-chip-remove" onclick="removeItemFilter(${item.id})">`;
    html += `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    html += `</button>`;
    html += `</div>`;
  });

  container.innerHTML = html;
}

function renderEntityList(role) {
  const container = document.getElementById(`${role}-entities`);
  const entities = entityFilters[role];

  if (entities.length === 0) {
    const emptyText = role === 'victim' ? 'No victims added' :
                      role === 'attacker' ? 'No attackers added' :
                      'No entities added';
    container.innerHTML = `<div class="advanced-filters__empty-state">${emptyText}</div>`;
    return;
  }

  let html = '';
  entities.forEach((entity, index) => {
    const showTicker = (entity.type === 'corporation' || entity.type === 'alliance') && entity.ticker;
    const ticker = showTicker ? ` &lt;${escapeHtml(entity.ticker)}&gt;` : '';
    const displayName = escapeHtml(entity.name) + ticker;
    html += `<div class="advanced-filters__entity-chip" draggable="true" data-entity-id="${entity.id}" data-entity-type="${entity.type}" data-entity-index="${index}" data-source-role="${role}">`;
    html += `<div class="advanced-filters__entity-chip-info">`;
    html += `<div class="advanced-filters__entity-chip-name">${displayName}</div>`;
    html += `<div class="advanced-filters__entity-chip-type">${entity.type}</div>`;
    html += `</div>`;
    html += `<button type="button" class="advanced-filters__entity-chip-remove" onclick="removeEntityFromRole(${entity.id}, '${entity.type}', '${role}')">`;
    html += `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    html += `</button>`;
    html += `</div>`;
  });

  container.innerHTML = html;

  // Re-attach drag event listeners
  attachDragListeners(container);

  // Re-setup drop zones
  setupDropZones();
}

function attachDragListeners(container) {
  const chips = container.querySelectorAll('.advanced-filters__entity-chip');

  chips.forEach(chip => {
    chip.addEventListener('dragstart', handleDragStart);
    chip.addEventListener('dragend', handleDragEnd);
  });
}

let draggedEntity = null;

function handleDragStart(e) {
  const chip = e.target.closest('.advanced-filters__entity-chip');
  if (!chip) return;

  draggedEntity = {
    id: parseInt(chip.dataset.entityId),
    type: chip.dataset.entityType,
    sourceRole: chip.dataset.sourceRole,
    index: parseInt(chip.dataset.entityIndex)
  };

  chip.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', ''); // Required for Firefox
}

function handleDragEnd(e) {
  const chip = e.target.closest('.advanced-filters__entity-chip');
  if (chip) {
    chip.classList.remove('dragging');
  }
}

// Setup drop zones - must be called after rendering
function setupDropZones() {
  const dropZones = document.querySelectorAll('.advanced-filters__entity-list');

  dropZones.forEach(zone => {
    // Remove old listeners
    zone.removeEventListener('dragover', handleDragOver);
    zone.removeEventListener('dragleave', handleDragLeave);
    zone.removeEventListener('drop', handleDrop);

    // Add new listeners
    zone.addEventListener('dragover', handleDragOver);
    zone.addEventListener('dragleave', handleDragLeave);
    zone.addEventListener('drop', handleDrop);
  });
}

// Initialize entity filters from server data
function initializeEntityFilters() {
  const serverData = {{{json filterDefaults.entityFilters}}};

  if (!serverData) return;

  // Populate entity filters from server data
  if (serverData.victim && serverData.victim.length > 0) {
    entityFilters.victim = serverData.victim;
    renderEntityList('victim');
  }

  if (serverData.attacker && serverData.attacker.length > 0) {
    entityFilters.attacker = serverData.attacker;
    renderEntityList('attacker');
  }

  if (serverData.both && serverData.both.length > 0) {
    entityFilters.both = serverData.both;
    renderEntityList('both');
  }
}

function initializeLocationFilters() {
  const serverData = {{{json filterDefaults.locationFilters}}};

  if (!serverData || serverData.length === 0) return;

  locationFilters = serverData;
  renderLocationList();
}

function initializeItemFilters() {
  const serverData = {{{json filterDefaults.itemFilters}}};

  if (!serverData || serverData.length === 0) return;

  itemFilters = serverData;
  renderItemList();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  setupDropZones();
  initializeEntityFilters();
  initializeLocationFilters();
  initializeItemFilters();
});

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
  if (e.currentTarget.contains(e.relatedTarget)) return;
  e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  e.currentTarget.classList.remove('drag-over');

  if (!draggedEntity) return;

  const targetRole = e.currentTarget.dataset.role;
  const sourceRole = draggedEntity.sourceRole;

  if (!targetRole) return;
  if (targetRole === sourceRole) return; // Same column, do nothing

  // Find the entity in source array
  const entity = entityFilters[sourceRole].find(e =>
    Number(e.id) === Number(draggedEntity.id) && String(e.type) === String(draggedEntity.type)
  );

  if (!entity) return;

  // Remove from source
  entityFilters[sourceRole] = entityFilters[sourceRole].filter(e =>
    !(Number(e.id) === Number(draggedEntity.id) && String(e.type) === String(draggedEntity.type))
  );

  // Add to target (check if not already there)
  const existsInTarget = entityFilters[targetRole].some(e =>
    Number(e.id) === Number(entity.id) && String(e.type) === String(entity.type)
  );

  if (!existsInTarget) {
    entityFilters[targetRole].push(entity);
  }

  // Re-render both lists
  renderEntityList(sourceRole);
  renderEntityList(targetRole);

  draggedEntity = null;
}

// Kill type handling
window.updateAdvancedKillTypeInputs = function(select) {
  document.getElementById('advanced-filter-solo').value = '';
  document.getElementById('advanced-filter-awox').value = '';
  document.getElementById('advanced-filter-npc').value = '';

  if (select.value) {
    document.getElementById('advanced-filter-' + select.value).value = '1';
  }
};

// Capsules toggle
window.toggleAdvancedCapsules = function(checkbox) {
  const form = checkbox.form;
  const oldInput = document.getElementById('advanced-filter-capsules-hidden');
  if (oldInput) oldInput.remove();

  if (!checkbox.checked) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'noCapsules';
    input.value = '1';
    input.id = 'advanced-filter-capsules-hidden';
    form.appendChild(input);
  }
};

// Form submission
window.submitAdvancedFilters = function() {
  const form = document.getElementById('advanced-filters-form');

  // Remove existing entity inputs
  form.querySelectorAll('[name^="victim"], [name^="attacker"], [name^="both"]').forEach(input => {
    if (input.name.includes('Character') || input.name.includes('Corporation') || input.name.includes('Alliance') || input.name.includes('System') || input.name.includes('Region') || input.name.includes('Constellation') || input.name.includes('Item')) {
      input.remove();
    }
  });

  // Add entity filters as hidden inputs
  for (const role in entityFilters) {
    entityFilters[role].forEach(entity => {
      const input = document.createElement('input');
      input.type = 'hidden';

      // Determine parameter name based on entity type and role
      const rolePrefix = role.charAt(0).toUpperCase() + role.slice(1); // Victim, Both, Attacker
      const typeSuffix = entity.type.charAt(0).toUpperCase() + entity.type.slice(1); // Character, Corporation, Alliance, etc.
      input.name = `${role}${typeSuffix}Id`;
      input.value = entity.id;

      form.appendChild(input);
    });
  }

  // Add location filters as hidden inputs
  locationFilters.forEach(location => {
    const input = document.createElement('input');
    input.type = 'hidden';
    const typeSuffix = location.type.charAt(0).toUpperCase() + location.type.slice(1); // System, Constellation, Region
    input.name = `solar${typeSuffix}Id`;
    input.value = location.id;
    form.appendChild(input);
  });

  // Add item filters as hidden inputs
  itemFilters.forEach(item => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'itemId';
    input.value = item.id;
    form.appendChild(input);
  });

  // Disable empty inputs
  form.querySelectorAll('input, select').forEach(input => {
    if (input.value === '' || (input.name === 'killTypeSelect')) {
      input.disabled = true;
    }
  });

  form.submit();
};

// Auto-scroll on hash
document.addEventListener('DOMContentLoaded', function() {
  if (window.location.hash === '#advanced-filters') {
    setTimeout(() => {
      const filters = document.querySelector('.advanced-filters');
      if (filters) {
        filters.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }
});
</script>
{{/if}}
