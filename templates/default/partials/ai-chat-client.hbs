// AI Chat Client with conversation history
(function() {
  const form = document.getElementById('ai-chat-form');
  const input = document.getElementById('ai-query-input');
  const submitBtn = document.getElementById('ai-submit-btn');
  const messagesContainer = document.getElementById('ai-messages');
  
  // Conversation history
  let conversationHistory = [];
  
  // Example query handlers
  document.querySelectorAll('.example-query').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const query = btn.dataset.query;
      if (query && !input.disabled) {
        input.value = query;
        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
      }
    });
  });
  
  // Add user message to chat
  function addUserMessage(text) {
    const messageEl = document.createElement('div');
    messageEl.className = 'ai-message ai-message--user';
    messageEl.innerHTML = `
      <div class="ai-message__avatar ai-message__avatar--user">üë§</div>
      <div class="ai-message__content">
        <div class="ai-message__role">You</div>
        <div class="ai-message__body">${escapeHtml(text)}</div>
      </div>
    `;
    messagesContainer.appendChild(messageEl);
    scrollToBottom();
  }
  
  // Add assistant message container
  function addAssistantMessage() {
    const messageEl = document.createElement('div');
    messageEl.className = 'ai-message ai-message--assistant';
    messageEl.innerHTML = `
      <div class="ai-message__avatar ai-message__avatar--assistant">ü§ñ</div>
      <div class="ai-message__content">
        <div class="ai-message__role ai-message__role--title">AI Assistant</div>
        <div class="ai-message__body message-content"></div>
      </div>
    `;
    messagesContainer.appendChild(messageEl);
    scrollToBottom();
    return messageEl.querySelector('.message-content');
  }
  
  // Show thinking state
  function showThinking(contentEl) {
    contentEl.innerHTML = `
      <div class="ai-thinking">
        <div class="ai-thinking__dots">
          <span>‚óè</span>
          <span>‚óè</span>
          <span>‚óè</span>
        </div>
        <span>Thinking...</span>
      </div>
    `;
  }
  
  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = input.value.trim();
    if (!query) return;
    
    // Disable input
    input.disabled = true;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Thinking...';
    
    // Add user message
    addUserMessage(query);
    
    // Clear input
    input.value = '';
    
    // Add assistant message container
    const contentEl = addAssistantMessage();
    showThinking(contentEl);
    
    try {
      // Call AI API with simple JSON
      const url = new URL('/api/ai/query', window.location.origin);
      url.searchParams.set('query', query);
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      // Clear thinking state
      contentEl.innerHTML = '';
      
      // Show tools used if any
      if (data.tools_used && data.tools_used.length > 0) {
        const toolsDiv = document.createElement('div');
        toolsDiv.className = 'ai-tools-used';
        toolsDiv.innerHTML = `üîß <strong>Tools used:</strong> ${data.tools_used.join(', ')}`;
        contentEl.appendChild(toolsDiv);
      }
      
      // Show HTML content if present
      if (data.html && data.html.trim()) {
        const htmlDiv = document.createElement('div');
        htmlDiv.className = 'ai-message__html';
        htmlDiv.innerHTML = data.html;
        contentEl.appendChild(htmlDiv);
      }
      
      // Show message if present (rendered as markdown)
      if (data.message && data.message.trim()) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'ai-markdown-content';
        msgDiv.innerHTML = renderMarkdown(data.message);
        contentEl.appendChild(msgDiv);
      }
      
      // If no content at all
      if (!data.html && !data.message) {
        contentEl.innerHTML = `<div class="ai-message__body">No response received.</div>`;
      }
      
      scrollToBottom();
      
    } catch (error) {
      contentEl.innerHTML = `<div class="ai-error">‚ùå <strong>Error:</strong> ${escapeHtml(error.message)}</div>`;
      scrollToBottom();
    } finally {
      // Re-enable input
      input.disabled = false;
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send';
      input.focus();
    }
  });
  
  function scrollToBottom() {
    requestAnimationFrame(() => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Simple markdown renderer (supports bold, italic, links, code, lists)
  function renderMarkdown(text) {
    let html = escapeHtml(text);
    
    // Bold: **text**
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Italic: *text*
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Links: [text](url)
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    
    // Inline code: `code`
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // Line breaks (double newline = paragraph, single = <br>)
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    html = '<p>' + html + '</p>';
    
    return html;
  }
  
  // Focus input on load
  input.focus();
})();
