<div class="kb-kl-list"
     {{#if wsFilter}}data-ws-filter-type="{{wsFilter.type}}" data-ws-filter-id="{{wsFilter.id}}" data-ws-filter-mode="{{wsFilter.mode}}" data-ws-filter-topic="{{wsFilter.topic}}"{{/if}}>
    {{#if (length killmails)}}
    <div class="kb-kl-row kb-kl-row--header">
        <div class="kb-kl-col kb-kl-col--ship">Ship type</div>
        <div class="kb-kl-col kb-kl-col--victim">Victim</div>
        <div class="kb-kl-col kb-kl-col--finalblow">Final blow</div>
        <div class="kb-kl-col kb-kl-col--location">Location</div>
        <div class="kb-kl-col kb-kl-col--value">Value</div>
        <div class="kb-kl-col kb-kl-col--time">Time</div>
    </div>

    {{#each killmails}}
  <div class="kb-kl-row{{#if isLoss}} kb-kl-row--loss{{/if}}" data-killmail-id="{{killmailId}}" data-killmail-time="{{killmailTime}}" onclick="window.location.href='/killmail/{{killmailId}}';" style="cursor: pointer;">
        <div class="kb-kl-col kb-kl-col--ship">
            <div class="kb-kl-ship">
        {{> partials/eve-image type="ship" id=victim.ship.typeId size=48 alt=victim.ship.name class="kb-kl-ship-icon"}}
                <div class="kb-kl-info kb-kl-info--ship">
                    <div class="kb-kl-info__primary">{{victim.ship.name}}</div>
                    <div class="kb-kl-info__secondary">{{victim.ship.group}}</div>
                </div>
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--victim">
            <div class="kb-kl-info kb-kl-info--victim">
                <div class="kb-kl-info__primary"{{#if victim.character.id}} data-character-id="{{victim.character.id}}"{{/if}}>
                    {{#if victim.character.id}}
                    <a href="/character/{{victim.character.id}}" class="kb-kl-info__link" onclick="event.stopPropagation();">{{victim.character.name}}</a>
                    {{else}}
                    {{victim.character.name}}
                    {{/if}}
                </div>
                <div class="kb-kl-info__secondary"{{#if victim.corporation.id}} data-corporation-id="{{victim.corporation.id}}"{{/if}}>
                    {{#if victim.corporation.id}}
                    <a href="/corporation/{{victim.corporation.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{victim.corporation.name}}</a>
                    {{else}}
                    {{victim.corporation.name}}
                    {{/if}}
                </div>
                {{#if victim.alliance}}
                <div class="kb-kl-info__secondary"{{#if victim.alliance.id}} data-alliance-id="{{victim.alliance.id}}"{{/if}}>
                    {{#if victim.alliance.id}}
                    <a href="/alliance/{{victim.alliance.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{victim.alliance.name}}</a>
                    {{else}}
                    {{victim.alliance.name}}
                    {{/if}}
                </div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--finalblow">
            <div class="kb-kl-info kb-kl-info--finalblow">
                {{#if attackers.[0]}}
                <div class="kb-kl-info__primary"{{#if attackers.[0].character.id}} data-character-id="{{attackers.[0].character.id}}"{{/if}}>
                    {{#if attackers.[0].character.id}}
                    <a href="/character/{{attackers.[0].character.id}}" class="kb-kl-info__link" onclick="event.stopPropagation();">{{attackers.[0].character.name}}</a>
                    {{else}}
                    {{attackers.[0].character.name}}
                    {{/if}}
                </div>
                <div class="kb-kl-info__secondary"{{#if attackers.[0].corporation.id}} data-corporation-id="{{attackers.[0].corporation.id}}"{{/if}}>
                    {{#if attackers.[0].corporation.id}}
                    <a href="/corporation/{{attackers.[0].corporation.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{attackers.[0].corporation.name}}</a>
                    {{else}}
                    {{attackers.[0].corporation.name}}
                    {{/if}}
                </div>
                {{#if attackers.[0].alliance}}
                <div class="kb-kl-info__secondary"{{#if attackers.[0].alliance.id}} data-alliance-id="{{attackers.[0].alliance.id}}"{{/if}}>
                    {{#if attackers.[0].alliance.id}}
                    <a href="/alliance/{{attackers.[0].alliance.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{attackers.[0].alliance.name}}</a>
                    {{else}}
                    {{attackers.[0].alliance.name}}
                    {{/if}}
                </div>
                {{/if}}
                {{else}}
                <div class="kb-kl-value--unknown">Unknown</div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--location">
            <div class="kb-kl-info">
                <div class="kb-kl-info__primary">{{solarSystem.name}}</div>
        <div class="kb-kl-info__secondary">{{solarSystem.region}}</div>
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--value">
            <div class="kb-kl-info kb-kl-info--value">
        {{#if totalValue}}
          <div class="kb-kl-value" data-total-value="{{killmailId}}">{{abbreviateISK totalValue}}</div>
                {{else}}
          <div class="kb-kl-value--unknown" data-total-value="{{killmailId}}">N/A</div>
                {{/if}}
        {{#if attackerCount}}
          <div class="kb-kl-info__secondary kb-kl-attackers-count">({{attackerCount}})</div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--time">
      <span class="kb-kl-time">{{killmailTimeRelative}}</span>
        </div>
    </div>
    {{/each}}
    {{else}}
    <div class="kb-kl-row kb-kl-row--empty">
        <div style="text-align: center; padding: 20px;">No killmails found.</div>
    </div>
    {{/if}}
</div>

<style>
.kb-kl-list {
  display: flex;
  flex-direction: column;
  gap: 0;
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: 4px;
  overflow: hidden;
  width: 100%;
  box-sizing: border-box;
}

.kb-kl-row {
  display: flex;
  flex-direction: row;
  gap: 1px;
  background-color: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid var(--color-border-dark);
  transition: background-color 0.2s ease;
}

.kb-kl-row:last-child {
  border-bottom: none;
}

.kb-kl-row:hover {
  background-color: rgba(74, 158, 255, 0.15);
}

.kb-kl-row--loss {
  background-color: rgba(139, 54, 54, 0.25) !important;
}

.kb-kl-row--loss:hover {
  background-color: rgba(139, 54, 54, 0.35) !important;
}

.kb-kl-row--header {
  background-color: transparent;
  color: var(--color-text-white);
  font-weight: 600;
  border-bottom: 1px solid var(--color-border-dark);
  position: sticky;
  top: 0;
  z-index: 10;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 11px;
}

.kb-kl-row--header .kb-kl-col {
  padding: 12px 16px;
  color: var(--color-text-secondary);
  font-size: 10px;
  font-weight: 600;
}

.kb-kl-row--empty {
  justify-content: center;
  align-items: center;
  min-height: 60px;
  color: var(--color-text-secondary);
  background: transparent !important;
  border: none !important;
}

.kb-kl-col {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  min-width: 0;
  overflow: hidden;
}

/* Column proportions for desktop - with flex grow to prevent cutoff */
.kb-kl-col--ship {
  flex: 1 1 22%;
  gap: 8px;
  min-width: 150px;
}

.kb-kl-col--victim {
  flex: 1 1 22%;
  min-width: 130px;
}

.kb-kl-col--finalblow {
  flex: 1 1 18%;
  min-width: 120px;
}

.kb-kl-col--location {
  flex: 1 1 13%;
  min-width: 100px;
}

.kb-kl-col--value {
  flex: 1 1 15%;
  justify-content: flex-end;
  min-width: 90px;
}

.kb-kl-col--time {
  flex: 0 0 10%;
  justify-content: center;
  min-width: 80px;
}

/* Ship container with image and info */
.kb-kl-ship {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  min-width: 0;
}

.kb-kl-ship-icon {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
  border: 0;
  display: block;
  border-radius: 2px;
}

.kb-kl-info {
  line-height: 1.3;
  overflow: hidden;
  flex: 1;
  min-width: 0;
}

.kb-kl-info--ship {
  min-width: 0;
}

.kb-kl-info--victim {
  min-width: 0;
}

.kb-kl-info--finalblow {
  min-width: 0;
}

.kb-kl-info--value {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  min-width: 0;
}

.kb-kl-info__primary {
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 11px;
  color: var(--color-text-white);
}

.kb-kl-info__secondary {
  color: var(--color-text-secondary);
  font-size: 9px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.kb-kl-info__link {
  color: #4a9eff;
  text-decoration: none;
  transition: color 0.2s ease;
}

.kb-kl-info__link:hover {
  color: #6ab3ff;
  text-decoration: underline;
}

.kb-kl-info__link--secondary {
  color: var(--color-text-secondary);
  text-decoration: none;
  transition: color 0.2s ease;
}

.kb-kl-info__link--secondary:hover {
  color: #4a9eff;
  text-decoration: underline;
}

.kb-kl-value {
  color: #4ade80;
  font-weight: 700;
  font-size: 11px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.kb-kl-value--unknown {
  color: var(--color-text-secondary);
  font-size: 9px;
}

.kb-kl-time {
  font-size: 9px;
  color: var(--color-text-secondary);
}

.kb-kl-attackers-count {
  text-align: right;
}

/* Responsive: collapse to single column on mobile */
@media (max-width: 1024px) {
  .kb-kl-col--ship { flex: 0 0 25%; }
  .kb-kl-col--victim { flex: 0 0 25%; }
  .kb-kl-col--finalblow { flex: 0 0 20%; }
  .kb-kl-col--location { flex: 0 0 15%; }
  .kb-kl-col--value { flex: 0 0 10%; }
  .kb-kl-col--time { flex: 0 0 5%; }
}

@media (max-width: 768px) {
  .kb-kl-row {
    flex-wrap: wrap;
    gap: 0;
  }

  .kb-kl-col {
    border-right: 1px solid var(--color-border-dark);
  }

  .kb-kl-col--ship { flex: 0 0 100%; border-right: none; }
  .kb-kl-col--victim { flex: 0 0 50%; }
  .kb-kl-col--finalblow { flex: 0 0 50%; border-left: 1px solid var(--color-border-dark); }
  .kb-kl-col--location { flex: 0 0 50%; border-right: none; }
  .kb-kl-col--value { flex: 0 0 50%; }
  .kb-kl-col--time { flex: 0 0 100%; border-left: none; }
}
</style>

<script type="module">
  // WebSocket configuration
  const WS_PORT = 3002;
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${window.location.hostname}:${WS_PORT}/ws`;

  let ws;
  let reconnectInterval = 1000;
  const MAX_RECONNECT_INTERVAL = 30000;

  // Get filter configuration from the killmail list
  const killmailList = document.querySelector('.kb-kl-list');
  if (!killmailList) {
    console.log('No killmail list found, skipping WebSocket setup');
  } else {
    const filterType = killmailList.dataset.wsFilterType; // 'character', 'corporation', 'alliance', 'killType'
    const filterId = killmailList.dataset.wsFilterId;
    const filterMode = killmailList.dataset.wsFilterMode; // 'all', 'kills', 'losses'
    const filterTopic = killmailList.dataset.wsFilterTopic; // For kill type pages

    function connect() {
      console.log('Connecting to WebSocket:', wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('âœ… WebSocket connected');
        reconnectInterval = 1000;

        // Subscribe based on filter configuration
        let topics = ['all']; // Default to all

        if (filterType === 'killType' && filterTopic) {
          // Kill type pages (latest, solo, big, etc.)
          topics = [filterTopic];
        } else if (filterType && filterId) {
          // Build topic based on entity type and ID
          if (filterType === 'character') {
            if (filterMode === 'kills') {
              topics = [`attacker.${filterId}`];
            } else if (filterMode === 'losses') {
              topics = [`victim.${filterId}`];
            } else {
              // Dashboard - both kills and losses
              topics = [`victim.${filterId}`, `attacker.${filterId}`];
            }
          } else if (filterType === 'corporation') {
            if (filterMode === 'kills') {
              topics = [`attacker.${filterId}`];
            } else if (filterMode === 'losses') {
              topics = [`victim.${filterId}`];
            } else {
              topics = [`victim.${filterId}`, `attacker.${filterId}`];
            }
          } else if (filterType === 'alliance') {
            if (filterMode === 'kills') {
              topics = [`attacker.${filterId}`];
            } else if (filterMode === 'losses') {
              topics = [`victim.${filterId}`];
            } else {
              topics = [`victim.${filterId}`, `attacker.${filterId}`];
            }
          }
        }

        console.log('ðŸ“¡ Subscribing to topics:', topics);
        ws.send(JSON.stringify({ type: 'subscribe', topics }));
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);

          if (message.type === 'subscribed') {
            console.log('âœ… Subscribed to topics:', message.topics);
          } else if (message.type === 'killmail' && message.data) {
            handleNewKillmail(message.data);
          } else if (message.type === 'ping') {
            ws.send(JSON.stringify({ type: 'pong' }));
          }
        } catch (error) {
          console.error('âŒ Error processing message:', error);
        }
      };

      ws.onclose = (event) => {
        console.log('ðŸ”´ WebSocket disconnected:', event.code, event.reason);
        setTimeout(connect, reconnectInterval);
        reconnectInterval = Math.min(reconnectInterval * 2, MAX_RECONNECT_INTERVAL);
      };

      ws.onerror = (error) => {
        console.error('âš ï¸  WebSocket error:', error);
      };
    }

    function handleNewKillmail(killmail) {
      // Additional client-side filtering for entity pages
      if (filterType && filterId) {
        const id = parseInt(filterId);
        let shouldShow = false;

        if (filterType === 'character') {
          const isVictim = killmail.victim?.character?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.character?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        } else if (filterType === 'corporation') {
          const isVictim = killmail.victim?.corporation?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.corporation?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        } else if (filterType === 'alliance') {
          const isVictim = killmail.victim?.alliance?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.alliance?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        }

        if (!shouldShow) {
          console.log('ðŸš« Filtered out killmail', killmail.killmailId);
          return;
        }
      }

      // Check if killmail is newer than the most recent one in the list
      const firstKillmailRow = killmailList.querySelector('.kb-kl-row[data-killmail-time]');
      if (firstKillmailRow) {
        const mostRecentTime = new Date(firstKillmailRow.dataset.killmailTime);
        const newKillmailTime = new Date(killmail.killmailTime);

        if (newKillmailTime <= mostRecentTime) {
          console.log('â° Killmail is not newer than most recent, skipping', {
            new: killmail.killmailTime,
            mostRecent: firstKillmailRow.dataset.killmailTime
          });
          return;
        }
      }

      // Determine if this is a loss for the filtered entity (only for entity pages)
      let isLoss = false;
      if (filterType && filterType !== 'killType' && filterId) {
        const id = parseInt(filterId);
        if (filterType === 'character') {
          isLoss = killmail.victim?.character?.id === id;
        } else if (filterType === 'corporation') {
          isLoss = killmail.victim?.corporation?.id === id;
        } else if (filterType === 'alliance') {
          isLoss = killmail.victim?.alliance?.id === id;
        }
      }

      // Create new killmail row
      const killmailRow = document.createElement('div');
      killmailRow.classList.add('kb-kl-row');
      if (isLoss) {
        killmailRow.classList.add('kb-kl-row--loss');
      }
      killmailRow.dataset.killmailId = killmail.killmailId;
      killmailRow.dataset.killmailTime = killmail.killmailTime;
      killmailRow.onclick = () => {
        window.location.href = `/killmail/${killmail.killmailId}`;
      };
      killmailRow.style.cursor = 'pointer';

      // Format value
      const formattedValue = new Intl.NumberFormat('en-US', {
        notation: 'compact',
        maximumFractionDigits: 1
      }).format(killmail.totalValue);

      killmailRow.innerHTML = `
        <div class="kb-kl-col kb-kl-col--ship">
          <div class="kb-kl-ship">
            <img src="https://images.evetech.net/types/${killmail.victim.ship.typeId}/icon?size=64" class="kb-kl-ship-icon" alt="${killmail.victim.ship.name}" loading="lazy">
            <div class="kb-kl-info kb-kl-info--ship">
              <div class="kb-kl-info__primary">${killmail.victim.ship.name}</div>
              <div class="kb-kl-info__secondary">${killmail.victim.ship.group}</div>
            </div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--victim">
          <div class="kb-kl-info kb-kl-info--victim">
            <div class="kb-kl-info__primary">
              <a href="/character/${killmail.victim?.character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.victim?.character?.name || 'Unknown'}</a>
            </div>
            <div class="kb-kl-info__secondary">
              <a href="/corporation/${killmail.victim?.corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.corporation?.name || 'Unknown'}</a>
            </div>
            ${killmail.victim.alliance ? `
            <div class="kb-kl-info__secondary">
              <a href="/alliance/${killmail.victim?.alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.alliance?.name || 'Unknown'}</a>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--finalblow">
          <div class="kb-kl-info kb-kl-info--finalblow">
            ${killmail.attackers && killmail.attackers.length > 0 ? `
              <div class="kb-kl-info__primary">
                <a href="/character/${killmail.attackers[0].character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.attackers[0].character?.name || 'Unknown'}</a>
              </div>
              <div class="kb-kl-info__secondary">
                <a href="/corporation/${killmail.attackers[0].corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].corporation?.name || 'Unknown'}</a>
              </div>
              ${killmail.attackers[0].alliance ? `
              <div class="kb-kl-info__secondary">
                <a href="/alliance/${killmail.attackers[0].alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].alliance?.name || 'Unknown'}</a>
              </div>
              ` : ''}
            ` : `
              <div class="kb-kl-info__primary">Unknown</div>
            `}
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--location">
          <div class="kb-kl-info">
            <div class="kb-kl-info__primary">${killmail.solarSystem.name}</div>
            <div class="kb-kl-info__secondary">${killmail.solarSystem.region}</div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--value">
          <div class="kb-kl-info kb-kl-info--value">
            <div class="kb-kl-value">${formattedValue}</div>
            <div class="kb-kl-info__secondary kb-kl-attackers-count">(${killmail.attackerCount})</div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--time">
          <span class="kb-kl-time">Just now</span>
        </div>
      `;

      // Insert after header
      const headerRow = killmailList.querySelector('.kb-kl-row--header');
      if (headerRow) {
        killmailList.insertBefore(killmailRow, headerRow.nextSibling);
      } else {
        killmailList.insertBefore(killmailRow, killmailList.firstChild);
      }

      // Keep list at max 30 items (+ 1 header)
      const MAX_KILLMAILS = 30;
      const rows = killmailList.querySelectorAll('.kb-kl-row:not(.kb-kl-row--header)');
      if (rows.length > MAX_KILLMAILS) {
        rows[rows.length - 1].remove();
      }

      console.log('âœ… Added killmail to list:', killmail.killmailId);
    }

    // Start connection
    connect();
  }
</script>
