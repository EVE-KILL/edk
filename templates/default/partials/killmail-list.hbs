<div class="kb-kl-list" data-killmail-list
     {{#if wsFilter}}data-ws-filter-type="{{wsFilter.type}}" data-ws-filter-id="{{wsFilter.id}}" data-ws-filter-mode="{{wsFilter.mode}}" data-ws-filter-topic="{{wsFilter.topic}}"{{/if}}
     data-ws-updates="{{#if (eq wsUpdates false)}}false{{else}}true{{/if}}">
    {{#if (length killmails)}}
    <div class="kb-kl-row kb-kl-row--header">
        <div class="kb-kl-col kb-kl-col--ship">Ship type</div>
        <div class="kb-kl-col kb-kl-col--victim">Victim</div>
        <div class="kb-kl-col kb-kl-col--finalblow">Final blow</div>
        <div class="kb-kl-col kb-kl-col--location">Location</div>
        <div class="kb-kl-col kb-kl-col--value">Value</div>
        <div class="kb-kl-col kb-kl-col--time">Time</div>
    </div>

      {{#each killmails}}
  <div class="kb-kl-row{{#if isLoss}} kb-kl-row--loss{{/if}}" data-killmail-id="{{killmailId}}" data-killmail-time="{{killmailTime}}" onclick="window.location.href='/killmail/{{killmailId}}';" style="cursor: pointer;">
        <div class="kb-kl-col kb-kl-col--ship">
            <div class="kb-kl-ship">
        {{> partials/eve-image type="ship" id=victim.ship.typeId size=48 alt=victim.ship.name class="kb-kl-ship-icon"}}
                <div class="kb-kl-info kb-kl-info--ship">
                    <div class="kb-kl-info__primary">{{victim.ship.name}}</div>
                    <div class="kb-kl-info__secondary">{{victim.ship.group}}</div>
                </div>
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--victim">
            <div class="kb-kl-info kb-kl-info--victim">
                <div class="kb-kl-info__primary"{{#if victim.character.id}} data-character-id="{{victim.character.id}}"{{/if}}>
                    {{#if victim.character.id}}
                    <a href="/character/{{victim.character.id}}" class="kb-kl-info__link" onclick="event.stopPropagation();">{{victim.character.name}}</a>
                    {{else}}
                    {{victim.character.name}}
                    {{/if}}
                </div>
                <div class="kb-kl-info__secondary"{{#if victim.corporation.id}} data-corporation-id="{{victim.corporation.id}}"{{/if}}>
                    {{#if victim.corporation.id}}
                    <a href="/corporation/{{victim.corporation.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{victim.corporation.name}}</a>
                    {{else}}
                    {{victim.corporation.name}}
                    {{/if}}
                </div>
                {{#if victim.alliance}}
                <div class="kb-kl-info__secondary"{{#if victim.alliance.id}} data-alliance-id="{{victim.alliance.id}}"{{/if}}>
                    {{#if victim.alliance.id}}
                    <a href="/alliance/{{victim.alliance.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{victim.alliance.name}}</a>
                    {{else}}
                    {{victim.alliance.name}}
                    {{/if}}
                </div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--finalblow">
            <div class="kb-kl-info kb-kl-info--finalblow">
                {{#if attackers.[0]}}
                <div class="kb-kl-info__primary"{{#if attackers.[0].character.id}} data-character-id="{{attackers.[0].character.id}}"{{/if}}>
                    {{#if attackers.[0].character.id}}
                    <a href="/character/{{attackers.[0].character.id}}" class="kb-kl-info__link" onclick="event.stopPropagation();">{{attackers.[0].character.name}}</a>
                    {{else}}
                    {{attackers.[0].character.name}}
                    {{/if}}
                </div>
                <div class="kb-kl-info__secondary"{{#if attackers.[0].corporation.id}} data-corporation-id="{{attackers.[0].corporation.id}}"{{/if}}>
                    {{#if attackers.[0].corporation.id}}
                    <a href="/corporation/{{attackers.[0].corporation.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{attackers.[0].corporation.name}}</a>
                    {{else}}
                    {{attackers.[0].corporation.name}}
                    {{/if}}
                </div>
                {{#if attackers.[0].alliance}}
                <div class="kb-kl-info__secondary"{{#if attackers.[0].alliance.id}} data-alliance-id="{{attackers.[0].alliance.id}}"{{/if}}>
                    {{#if attackers.[0].alliance.id}}
                    <a href="/alliance/{{attackers.[0].alliance.id}}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">{{attackers.[0].alliance.name}}</a>
                    {{else}}
                    {{attackers.[0].alliance.name}}
                    {{/if}}
                </div>
                {{/if}}
                {{else}}
                <div class="kb-kl-value--unknown">Unknown</div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--location">
            <div class="kb-kl-info">
                <div class="kb-kl-info__primary">{{solarSystem.name}} <span class="security {{securityColor solarSystem.security}}">({{formatSecurity solarSystem.security}})</span></div>
        <div class="kb-kl-info__secondary">{{solarSystem.region}}</div>
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--value">
            <div class="kb-kl-info kb-kl-info--value">
        {{#if (gt totalValue 0)}}
          <div class="kb-kl-value" data-total-value="{{killmailId}}">{{abbreviateISK totalValue}}</div>
                {{else}}
          <div class="kb-kl-value--unknown" data-total-value="{{killmailId}}">N/A</div>
                {{/if}}
        {{#if attackerCount}}
          <div class="kb-kl-info__secondary kb-kl-attackers-count">({{attackerCount}})</div>
                {{/if}}
            </div>
        </div>

        <div class="kb-kl-col kb-kl-col--time">
      <span class="kb-kl-time">{{killmailTimeRelative}}</span>
        </div>
    </div>
    {{/each}}
    {{else}}
    <div class="kb-kl-row kb-kl-row--empty">
        <div style="text-align: center; padding: 20px;">No killmails found.</div>
    </div>
    {{/if}}
</div>

<style>
.kb-kl-list {
  display: flex;
  flex-direction: column;
  gap: 0;
  background: var(--color-bg-tertiary);
  border: 1px solid var(--color-border-dark);
  border-radius: var(--radius-sm);
  overflow: hidden;
  width: 100%;
  box-sizing: border-box;
}

.kb-kl-row {
  display: flex;
  flex-direction: row;
  gap: 1px;
  background-color: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid var(--color-border-dark);
  transition: background-color 0.2s ease;
}

.kb-kl-row:last-child {
  border-bottom: none;
}

.kb-kl-row:hover {
  background-color: rgba(74, 158, 255, 0.15);
}

.kb-kl-row--loss {
  background-color: rgba(139, 54, 54, 0.25) !important;
}

.kb-kl-row--loss:hover {
  background-color: rgba(139, 54, 54, 0.35) !important;
}

.kb-kl-row--header {
  background-color: transparent;
  color: var(--color-text-white);
  font-weight: 600;
  border-bottom: 1px solid var(--color-border-dark);
  position: sticky;
  top: 0;
  z-index: 10;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 11px;
}

.kb-kl-row--header .kb-kl-col {
  padding: 12px 16px;
  color: var(--color-text-secondary);
  font-size: 10px;
  font-weight: 600;
}

.kb-kl-row--empty {
  justify-content: center;
  align-items: center;
  min-height: 60px;
  color: var(--color-text-secondary);
  background: transparent !important;
  border: none !important;
}

.kb-kl-col {
  display: flex;
  align-items: center;
  padding: 5px 10px;
  min-width: 0;
  overflow: hidden;
}

/* Column proportions for desktop - with flex grow to prevent cutoff */
.kb-kl-col--ship {
  flex: 1 1 30%;
  gap: 4px;
  min-width: 140px;
}

.kb-kl-col--victim {
  flex: 1 1 22%;
  min-width: 135px;
}

.kb-kl-col--finalblow {
  flex: 1 1 18%;
  min-width: 125px;
}

.kb-kl-col--location {
  flex: 1 1 30%;
  min-width: 115px;
}

.kb-kl-col--value {
  flex: 1 1 15%;
  justify-content: flex-end;
  min-width: 90px;
}

.kb-kl-col--time {
  flex: 0 0 10%;
  justify-content: center;
  min-width: 80px;
}

/* Ship container with image and info */
.kb-kl-ship {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  min-width: 0;
}

.kb-kl-ship-icon {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
  border: 0;
  display: block;
  border-radius: var(--radius-sm);
}

.kb-kl-info {
  line-height: 1.3;
  overflow: hidden;
  flex: 1;
  min-width: 0;
}

.kb-kl-info--ship {
  min-width: 0;
}

.kb-kl-info--victim {
  min-width: 0;
}

.kb-kl-info--finalblow {
  min-width: 0;
}

.kb-kl-info--value {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  min-width: 0;
}

.kb-kl-info__primary {
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 11px;
  color: var(--color-text-white);
}

.kb-kl-info__secondary {
  color: var(--color-text-secondary);
  font-size: 9px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.kb-kl-info__link {
  color: #4a9eff;
  text-decoration: none;
  transition: color 0.2s ease;
}

.kb-kl-info__link:hover {
  color: #6ab3ff;
  text-decoration: underline;
}

.kb-kl-info__link--secondary {
  color: var(--color-text-secondary);
  text-decoration: none;
  transition: color 0.2s ease;
}

.kb-kl-info__link--secondary:hover {
  color: #4a9eff;
  text-decoration: underline;
}

.kb-kl-value {
  color: #4ade80;
  font-weight: 700;
  font-size: 11px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.kb-kl-value--unknown {
  color: var(--color-text-secondary);
  font-size: 9px;
}

.kb-kl-time {
  font-size: 9px;
  color: var(--color-text-secondary);
}

.kb-kl-attackers-count {
  text-align: right;
}

/* Responsive: collapse to single column on mobile */
@media (max-width: 1024px) {
  .kb-kl-col--ship { flex: 0 0 25%; }
  .kb-kl-col--victim { flex: 0 0 25%; }
  .kb-kl-col--finalblow { flex: 0 0 20%; }
  .kb-kl-col--location { flex: 0 0 15%; }
  .kb-kl-col--value { flex: 0 0 10%; }
  .kb-kl-col--time { flex: 0 0 5%; }
}

@media (max-width: 768px) {
  .kb-kl-row {
    flex-wrap: wrap;
    gap: 0;
  }

  .kb-kl-col {
    border-right: 1px solid var(--color-border-dark);
  }

  .kb-kl-col--ship { flex: 0 0 100%; border-right: none; }
  .kb-kl-col--victim { flex: 0 0 50%; }
  .kb-kl-col--finalblow { flex: 0 0 50%; border-left: 1px solid var(--color-border-dark); }
  .kb-kl-col--location { flex: 0 0 50%; border-right: none; }
  .kb-kl-col--value { flex: 0 0 50%; }
  .kb-kl-col--time { flex: 0 0 100%; border-left: none; }
}
</style>

<script type="module">
  // No-op placeholder to maintain structure after removing client time-ago helper
  const refreshTimes = () => {};

  const killmailList = document.querySelector('.kb-kl-list');
  const killmailListContainer = document.querySelector('[data-killmail-list]');

  // Check if WebSocket updates are disabled
  if (killmailListContainer && killmailListContainer.dataset.wsUpdates === 'false') {
    console.log('[Killlist] WebSocket updates disabled via data-ws-updates="false"');
  } else if (!killmailList) {
    console.log('[Killlist] No killmail list found, skipping WebSocket setup');
  } else {
    const SHIP_GROUPS = {
      big: [547, 485, 513, 902, 941, 30, 659],
      frigates: [324, 893, 25, 831, 237],
      destroyers: [420, 541],
      cruisers: [906, 26, 833, 358, 894, 832, 963],
      battlecruisers: [419, 540],
      battleships: [27, 898, 900],
      capitals: [547, 485],
      freighters: [513, 902],
      supercarriers: [659],
      titans: [30],
      citadels: [1657, 1406, 1404, 1408, 2017, 2016],
      t1: [419, 27, 29, 547, 26, 420, 25, 28, 941, 463, 237, 31],
      t2: [
        324, 898, 906, 540, 830, 893, 543, 541, 833, 358, 894, 831, 902, 832,
        900, 834, 380
      ],
      t3: [963, 1305]
    };

    const CAPSULE_GROUP_IDS = [29, 4053]; // Capsule and Irregular Capsule (Golden Pod)
    const WORMHOLE_REGION_MIN = 11000001;
    const WORMHOLE_REGION_MAX = 11000033;
    const ABYSSAL_REGION_MIN = 12000000;
    const ABYSSAL_REGION_MAX = 13000000;
    const POCHVEN_REGION_ID = 10000070;

    const filterType = killmailList.dataset.wsFilterType; // 'character', 'corporation', 'alliance', 'killType'
    const filterId = killmailList.dataset.wsFilterId;
    const filterMode = killmailList.dataset.wsFilterMode; // 'all', 'kills', 'losses'
    const filterTopic = killmailList.dataset.wsFilterTopic; // For kill type pages
    const subscriptionKey = `killlist:${filterType || 'all'}:${filterId || 'all'}:${filterMode || 'all'}:${filterTopic || 'latest'}`;
    const topics = buildTopics();

    // Parse URL filters for client-side filtering
    const urlFilters = parseUrlFilters();
    let unsubscribeTopics = null;
    let removeKillmailHandler = null;
    let cleanupTimer = null;

    function startKillmailStream() {
      const client = window.__edkWS;
      if (!client) return false;

      unsubscribeTopics = client.setTopics(subscriptionKey, topics);
      removeKillmailHandler = client.on('killmail', (message) => {
        const killmail = message?.data ?? message;
        if (killmail) handleNewKillmail(killmail);
      });
      return true;
    }

    if (!startKillmailStream()) {
      const readyListener = () => {
        if (startKillmailStream()) {
          window.removeEventListener('edk-ws-ready', readyListener);
        }
      };
      window.addEventListener('edk-ws-ready', readyListener);

      // Also poll for __edkWS in case event already fired
      const pollInterval = setInterval(() => {
        if (startKillmailStream()) {
          clearInterval(pollInterval);
          window.removeEventListener('edk-ws-ready', readyListener);
        }
      }, 100);

      // Stop polling after 5 seconds
      setTimeout(() => clearInterval(pollInterval), 5000);
    }

    function cleanup() {
      if (unsubscribeTopics) unsubscribeTopics();
      if (removeKillmailHandler) removeKillmailHandler();
      cleanupTimer = null;
    }

    function scheduleCleanup() {
      if (cleanupTimer) return;
      cleanupTimer = setTimeout(() => {
        cleanup();
        const client = window.__edkWS;
        if (client) {
          // Inform worker to drop this namespace promptly
          client.clearTopics(subscriptionKey);
        }
      }, 3000); // linger a bit to survive fast navigations
    }

    function cancelCleanup() {
      if (cleanupTimer) {
        clearTimeout(cleanupTimer);
        cleanupTimer = null;
      }
    }

    window.addEventListener('pagehide', scheduleCleanup);
    window.addEventListener('beforeunload', cleanup);
    window.addEventListener('pageshow', cancelCleanup);

    // Parse URL parameters into filters
    function parseUrlFilters() {
      const params = new URLSearchParams(window.location.search);
      const filters = {};

      // Value filters
      const minValue = params.get('minTotalValue') || params.get('minValue');
      if (minValue) filters.minTotalValue = Number(minValue);

      // Security status
      const securityStatus = params.get('securityStatus');
      if (securityStatus) filters.securityStatus = securityStatus;

      // Ship class filter
      const shipClass = params.get('shipClass');
      if (shipClass) filters.shipClass = shipClass;

      // Tech level filter
      const techLevel = params.get('techLevel');
      if (techLevel) filters.techLevel = techLevel;

      // Kill type filters
      if (params.get('solo') === '1') filters.isSolo = true;
      if (params.get('npc') === '1') filters.isNpc = true;
      if (params.get('awox') === '1') filters.isAwox = true;

      // Capsule filter
      if (params.get('noCapsules') === '1') filters.noCapsules = true;

      return filters;
    }

    // Check if killmail matches URL filters
    function matchesUrlFilters(killmail, filters) {
      // Value filter
      if (filters.minTotalValue && killmail.totalValue < filters.minTotalValue) {
        return false;
      }

      // Security status filter
      if (filters.securityStatus) {
        const security = killmail.system?.security ?? 0;
        const regionId = killmail.system?.regionId ?? 0;

        switch (filters.securityStatus) {
          case 'highsec':
            if (security < 0.45) return false;
            break;
          case 'lowsec':
            if (security < 0.0 || security >= 0.45) return false;
            break;
          case 'nullsec':
            if (security >= 0.0 || (regionId >= WORMHOLE_REGION_MIN && regionId <= WORMHOLE_REGION_MAX)) return false;
            break;
          case 'wormhole':
            if (regionId < WORMHOLE_REGION_MIN || regionId > WORMHOLE_REGION_MAX) return false;
            break;
          case 'abyssal':
            if (regionId < ABYSSAL_REGION_MIN || regionId > ABYSSAL_REGION_MAX) return false;
            break;
          case 'pochven':
            if (regionId !== POCHVEN_REGION_ID) return false;
            break;
        }
      }

      // Ship class filter
      if (filters.shipClass) {
        const shipGroupId = killmail.victim?.ship?.groupId;
        const classGroups = SHIP_GROUPS[filters.shipClass];
        if (classGroups && !classGroups.includes(shipGroupId)) {
          return false;
        }
      }

      // Tech level filter
      if (filters.techLevel) {
        const shipGroupId = killmail.victim?.ship?.groupId;
        const techGroups = SHIP_GROUPS[filters.techLevel];
        if (techGroups && !techGroups.includes(shipGroupId)) {
          return false;
        }
      }

      // Solo filter
      if (filters.isSolo && killmail.attackerCount > 1) {
        return false;
      }

      // NPC filter
      if (filters.isNpc && !killmail.npc) {
        return false;
      }

      // Awox filter
      if (filters.isAwox && !killmail.awox) {
        return false;
      }

      // Capsule filter
      if (filters.noCapsules) {
        const shipGroupId = killmail.victim?.ship?.groupId;
        if (CAPSULE_GROUP_IDS.includes(shipGroupId)) {
          return false;
        }
      }

      return true;
    }

    function buildTopics() {
      if (filterType === 'killType' && filterTopic) {
        return [filterTopic];
      }

      if (filterType === 'character' && filterId) {
        if (filterMode === 'kills') {
          return [`attacker.${filterId}`];
        }
        if (filterMode === 'losses') {
          return [`victim.${filterId}`];
        }
        return [`victim.${filterId}`, `attacker.${filterId}`];
      }

      if (filterType === 'corporation' && filterId) {
        if (filterMode === 'kills') {
          return [`attacker.${filterId}`];
        }
        if (filterMode === 'losses') {
          return [`victim.${filterId}`];
        }
        return [`victim.${filterId}`, `attacker.${filterId}`];
      }

      if (filterType === 'alliance' && filterId) {
        if (filterMode === 'kills') {
          return [`attacker.${filterId}`];
        }
        if (filterMode === 'losses') {
          return [`victim.${filterId}`];
        }
        return [`victim.${filterId}`, `attacker.${filterId}`];
      }

      return ['all'];
    }

    function handleNewKillmail(killmail) {
      // First check URL filters (applies to all pages)
      if (!matchesUrlFilters(killmail, urlFilters)) {
        console.log('ðŸš« Filtered out by URL filters:', killmail.killmailId);
        return;
      }

      // Additional client-side filtering for entity pages
      if (filterType && filterId) {
        const id = parseInt(filterId);
        let shouldShow = false;

        if (filterType === 'character') {
          const isVictim = killmail.victim?.character?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.character?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        } else if (filterType === 'corporation') {
          const isVictim = killmail.victim?.corporation?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.corporation?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        } else if (filterType === 'alliance') {
          const isVictim = killmail.victim?.alliance?.id === id;
          const isAttacker = killmail.attackers?.some(a => a.alliance?.id === id);

          if (filterMode === 'kills') {
            shouldShow = isAttacker && !isVictim;
          } else if (filterMode === 'losses') {
            shouldShow = isVictim;
          } else {
            shouldShow = isVictim || isAttacker;
          }
        }

        if (!shouldShow) {
          console.log('ðŸš« Filtered out by entity filter:', killmail.killmailId);
          return;
        }
      } else if (filterType === 'killType' && filterTopic) {
        if (!matchesKillTypeFilter(killmail, filterTopic)) {
          return;
        }
      }

      // Check if killmail is newer than the most recent one in the list
      const firstKillmailRow = killmailList.querySelector('.kb-kl-row[data-killmail-time]');
      if (firstKillmailRow) {
        const mostRecentTime = new Date(firstKillmailRow.dataset.killmailTime);
        const newKillmailTime = new Date(killmail.killmailTime);

        if (newKillmailTime <= mostRecentTime) {
          return;
        }
      }

      // Determine if this is a loss for the filtered entity (only for entity pages)
      let isLoss = false;
      if (filterType && filterType !== 'killType' && filterId) {
        const id = parseInt(filterId);
        if (filterType === 'character') {
          isLoss = killmail.victim?.character?.id === id;
        } else if (filterType === 'corporation') {
          isLoss = killmail.victim?.corporation?.id === id;
        } else if (filterType === 'alliance') {
          isLoss = killmail.victim?.alliance?.id === id;
        }
      }

      // Create new killmail row
      const killmailRow = document.createElement('div');
      killmailRow.classList.add('kb-kl-row');
      if (isLoss) {
        killmailRow.classList.add('kb-kl-row--loss');
      }
      killmailRow.dataset.killmailId = killmail.killmailId;
      killmailRow.dataset.killmailTime = killmail.killmailTime;
      killmailRow.onclick = () => {
        window.location.href = `/killmail/${killmail.killmailId}`;
      };
      killmailRow.style.cursor = 'pointer';

      const totalValueNumber = Number(killmail.totalValue ?? 0);
      const hasValue = Number.isFinite(totalValueNumber) && totalValueNumber > 0;
      const formattedValue = hasValue
        ? new Intl.NumberFormat('en-US', {
            notation: 'compact',
            maximumFractionDigits: 1
          }).format(totalValueNumber)
        : 'N/A';

      killmailRow.innerHTML = `
        <div class="kb-kl-col kb-kl-col--ship">
          <div class="kb-kl-ship">
            <img src="https://images.eve-kill.com/types/${killmail.victim.ship.id}/icon?size=64" class="kb-kl-ship-icon" alt="${killmail.victim.ship.name}" loading="lazy">
            <div class="kb-kl-info kb-kl-info--ship">
              <div class="kb-kl-info__primary">${killmail.victim.ship.name}</div>
              <div class="kb-kl-info__secondary">${killmail.victim.ship.group}</div>
            </div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--victim">
          <div class="kb-kl-info kb-kl-info--victim">
            <div class="kb-kl-info__primary">
              <a href="/character/${killmail.victim?.character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.victim?.character?.name || 'Unknown'}</a>
            </div>
            <div class="kb-kl-info__secondary">
              <a href="/corporation/${killmail.victim?.corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.corporation?.name || 'Unknown'}</a>
            </div>
            ${killmail.victim.alliance ? `
            <div class="kb-kl-info__secondary">
              <a href="/alliance/${killmail.victim?.alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.victim?.alliance?.name || 'Unknown'}</a>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--finalblow">
          <div class="kb-kl-info kb-kl-info--finalblow">
            ${killmail.attackers && killmail.attackers.length > 0 ? `
              <div class="kb-kl-info__primary">
                <a href="/character/${killmail.attackers[0].character?.id || 0}" class="kb-kl-info__link" onclick="event.stopPropagation();">${killmail.attackers[0].character?.name || 'Unknown'}</a>
              </div>
              <div class="kb-kl-info__secondary">
                <a href="/corporation/${killmail.attackers[0].corporation?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].corporation?.name || 'Unknown'}</a>
              </div>
              ${killmail.attackers[0].alliance ? `
              <div class="kb-kl-info__secondary">
                <a href="/alliance/${killmail.attackers[0].alliance?.id || 0}" class="kb-kl-info__link--secondary" onclick="event.stopPropagation();">${killmail.attackers[0].alliance?.name || 'Unknown'}</a>
              </div>
              ` : ''}
            ` : `
              <div class="kb-kl-info__primary">Unknown</div>
            `}
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--location">
          <div class="kb-kl-info">
            <div class="kb-kl-info__primary">${killmail.solarSystem?.name || 'Unknown'}</div>
            <div class="kb-kl-info__secondary">${killmail.regionName || 'Unknown'}</div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--value">
          <div class="kb-kl-info kb-kl-info--value">
            <div class="kb-kl-value${hasValue ? '' : ' kb-kl-value--unknown'}">${formattedValue}</div>
            <div class="kb-kl-info__secondary kb-kl-attackers-count">(${killmail.attackerCount})</div>
          </div>
        </div>
        <div class="kb-kl-col kb-kl-col--time">
          <span class="kb-kl-time">Just now</span>
        </div>
      `;

      // Insert after header
      const headerRow = killmailList.querySelector('.kb-kl-row--header');
      if (headerRow) {
        killmailList.insertBefore(killmailRow, headerRow.nextSibling);
      } else {
        killmailList.insertBefore(killmailRow, killmailList.firstChild);
      }

      // Keep list at max items (+ 1 header)
      const MAX_KILLMAILS = {{fallback limit 25}};
      const rows = killmailList.querySelectorAll('.kb-kl-row:not(.kb-kl-row--header)');
      if (rows.length > MAX_KILLMAILS) {
        rows[rows.length - 1].remove();
      }

      // Update relative time display for new/affected rows
      refreshTimes();
    }

    function matchesKillTypeFilter(killmail, topic) {
      const groupId = killmail?.victim?.ship?.groupId;
      const totalValue = Number(killmail?.totalValue ?? 0);
      const security = Number(killmail?.securityStatus ?? 0);
      const regionId = Number(killmail?.regionId ?? 0);

      switch (topic) {
        case 'latest':
          return true;
        case 'big':
          return SHIP_GROUPS.big.includes(groupId);
        case 'solo':
          return !!killmail?.solo;
        case 'npc':
          return !!killmail?.npc;
        case 'awox':
          return !!killmail?.awox;
        case 'highsec':
          return security >= 0.45;
        case 'lowsec':
          return security >= 0 && security < 0.45;
        case 'nullsec':
          return security < 0 && (regionId < WORMHOLE_REGION_MIN || regionId > WORMHOLE_REGION_MAX);
        case 'w-space':
          return regionId >= WORMHOLE_REGION_MIN && regionId <= WORMHOLE_REGION_MAX;
        case 'abyssal':
          return regionId >= ABYSSAL_REGION_MIN && regionId <= ABYSSAL_REGION_MAX;
        case 'pochven':
          return regionId === POCHVEN_REGION_ID;
        case '5b':
          return totalValue >= 5_000_000_000;
        case '10b':
          return totalValue >= 10_000_000_000;
        case 'frigates':
          return SHIP_GROUPS.frigates.includes(groupId);
        case 'destroyers':
          return SHIP_GROUPS.destroyers.includes(groupId);
        case 'cruisers':
          return SHIP_GROUPS.cruisers.includes(groupId);
        case 'battlecruisers':
          return SHIP_GROUPS.battlecruisers.includes(groupId);
        case 'battleships':
          return SHIP_GROUPS.battleships.includes(groupId);
        case 'capitals':
          return SHIP_GROUPS.capitals.includes(groupId);
        case 'freighters':
          return SHIP_GROUPS.freighters.includes(groupId);
        case 'supercarriers':
          return SHIP_GROUPS.supercarriers.includes(groupId);
        case 'titans':
          return SHIP_GROUPS.titans.includes(groupId);
        case 'citadels':
        case 'structures':
          return SHIP_GROUPS.citadels.includes(groupId);
        case 't1':
          return SHIP_GROUPS.t1.includes(groupId);
        case 't2':
          return SHIP_GROUPS.t2.includes(groupId);
        case 't3':
          return SHIP_GROUPS.t3.includes(groupId);
        default:
          return true;
      }
    }
  }
</script>
