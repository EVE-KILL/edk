# Homepage Statistics

## Overview

The EVE Kill v4 homepage displays comprehensive killboard statistics that can be filtered to specific entities (characters, corporations, or alliances) via `.env` configuration. This allows both global killboards (all killmails) and focused killboards (specific entities only).

## Features

### Overall Statistics
- **Total Killmails**: Total number of killmails in the database
- **Total ISK Destroyed**: Sum of all ISK values from killmails (in TEXT format for large numbers)
- **Solo Kills**: Killmails marked as solo kills
- **NPC Kills**: Killmails marked as NPC kills
- **Average Attackers per Kill**: Average number of attackers across all killmails
- **Unique Pilots**: Count of distinct pilots (as attackers)

### Activity Metrics
- **Active Pilots (24h)**: Distinct pilots who participated in kills in the last 24 hours
- **Active Pilots (7d)**: Distinct pilots who participated in kills in the last 7 days
- **Kills (Last 24h)**: Total killmails in the last 24 hours
- **Kills (Last 7d)**: Total killmails in the last 7 days
- **Kills (Last 30d)**: Total killmails in the last 30 days

### Top Entities
- **Top Killer**: Character with the most final blows (kill count)
- **Top Corporation**: Corporation with the most attacker participations (kill count)
- **Top Alliance**: Alliance with the most attacker participations (kill count)

### Ships & Systems
- **Most Destroyed Ship**: Ship type that has been destroyed the most (victim ship)
- **Most Used Ship**: Ship type that has been used the most (attacker ship)
- **Most Dangerous System**: Solar system with the most killmails

## Filtering

### .env Configuration

Add comma-separated entity IDs to filter statistics to specific entities:

```bash
# Follow specific characters
FOLLOWED_CHARACTER_IDS=123456789,987654321

# Follow specific corporations
FOLLOWED_CORPORATION_IDS=98000001,98000002

# Follow specific alliances
FOLLOWED_ALLIANCE_IDS=99000001,99000002
```

### Filter Behavior

When followed entities are set:
1. Statistics include killmails where the **victim OR any attacker** matches the followed entity IDs
2. Multiple filters are combined with **OR logic** (any match includes the killmail)
3. Leave all followed entities empty for a global killboard showing all killmails

### Examples

#### Global Killboard (No Filters)

```bash
FOLLOWED_CHARACTER_IDS=
FOLLOWED_CORPORATION_IDS=
FOLLOWED_ALLIANCE_IDS=
```

Shows statistics for **all killmails** in the database.

#### Alliance Killboard

```bash
FOLLOWED_CHARACTER_IDS=
FOLLOWED_CORPORATION_IDS=
FOLLOWED_ALLIANCE_IDS=99003214
```

Shows statistics for killmails where **alliance 99003214 was victim or attacker**.

#### Multi-Entity Killboard

```bash
FOLLOWED_CHARACTER_IDS=123456789,987654321
FOLLOWED_CORPORATION_IDS=98000001
FOLLOWED_ALLIANCE_IDS=99000001,99000002
```
Shows statistics for killmails involving:
- Character 123456789 OR 987654321
- OR Corporation 98000001
- OR Alliance 99000001 OR 99000002

## Implementation

### Generator Function

The statistics are generated by `/app/generators/statistics.ts`:

```typescript
import { getKillboardStatistics } from "../generators/statistics";

// With filtering
const stats = await getKillboardStatistics({
  characterIds: [123456789, 987654321],
  corporationIds: [98000001],
  allianceIds: [99000001],
});

// Without filtering (global)
const stats = await getKillboardStatistics();
```

### Response Interface

```typescript
interface KillboardStatistics {
  // Overall stats
  totalKillmails: number;
  totalKills: number;
  totalLosses: number;

  // ISK stats
  totalISKDestroyed: string; // TEXT format for big integers
  totalISKLost: string;

  // Pilot activity
  activePilotsLast7Days: number;
  activePilotsLast24Hours: number;
  totalUniquePilots: number;

  // Time-based kill counts
  killsLast24Hours: number;
  killsLast7Days: number;
  killsLast30Days: number;

  // Ship stats
  mostDestroyedShip: { name: string; count: number } | null;
  mostUsedShip: { name: string; count: number } | null;

  // System stats
  mostDangerousSystem: { name: string; count: number } | null;

  // Top entities
  topKiller: { name: string; kills: number } | null;
  topCorporation: { name: string; kills: number } | null;
  topAlliance: { name: string; kills: number } | null;

  // Misc
  soloKills: number;
  npcKills: number;
  averageAttackersPerKill: number;
}
```

## Performance

### Query Optimization
- All statistics queries run in **parallel** using `Promise.all()`
- Database indexes used:
  - `killmails.killmail_time` for time-based queries
  - `victims.character_id`, `victims.corporation_id`, `victims.alliance_id`
  - `attackers.character_id`, `attackers.corporation_id`, `attackers.alliance_id`
  - `attackers.final_blow` for top killer queries

### Caching
Statistics are not currently cached but could be cached at the route level:
```typescript
// In route controller
static cacheTTL = 300; // 5 minutes
static cacheKey = "homepage:stats";
```

## Known Issues

### ISK Values
Currently, `totalValue` field in killmails table is not being populated during killmail import. All values show as `0` until the import process is updated to fetch and store ISK values from zKillboard.

**TODO**: Update killmail processor to fetch and store `zkb.totalValue` from zKillboard API.

### Entity Names
Currently showing IDs instead of names for:
- Top Killer (Character ID)
- Top Corporation (Corporation ID)
- Top Alliance (Alliance ID)
- Most Destroyed Ship (Type ID)
- Most Used Ship (Type ID)
- Most Dangerous System (System ID)

**TODO**: Join with entity tables (characters, corporations, alliances, types, solar_systems) to fetch and display names.

### Kills vs Losses
The `totalKills` and `totalLosses` separation is not yet implemented. Currently only showing combined total.

**TODO**: Implement proper kill/loss separation based on filter criteria.

## Future Enhancements

1. **Caching**: Cache statistics for 5-10 minutes to reduce database load
2. **Entity Names**: Fetch and display actual names instead of IDs
3. **Kills/Losses Breakdown**: Separate statistics for kills vs losses
4. **More Top Lists**: Top 10 killers, top 10 corps, etc. (dedicated page)
5. **Time-Series Graphs**: Visual charts for activity over time
6. **Efficiency Ratings**: ISK efficiency percentages, kill/death ratios
7. **Weapon Statistics**: Most used weapons, most deadly weapons
8. **Daily Activity**: Heatmap showing most active times of day
