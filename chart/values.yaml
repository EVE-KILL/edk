# Default values for edk
global:
  image:
    registry: ghcr.io
    repository: eve-kill/edk
    tag: latest
    pullPolicy: IfNotPresent
  
  # Environment variables shared across all services
  env:
    NODE_ENV: production
    EDK_CONTAINER: "true"
    REDIS_HOST: edk-redis-master
    REDIS_PORT: "6379"
    
    # Sensitive values (should be overridden or use secrets)
    sensitive:
      DATABASE_URL: ""  # Will be set from CloudNativePG secret
      REDIS_PASSWORD: ""

# Frontend web application
web:
  enabled: true
  replicaCount: 3
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  service:
    type: ClusterIP
    port: 3000
  
  livenessProbe:
    httpGet:
      path: /health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /health
      port: 3000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Queue workers - individual pods per queue type
queue:
  enabled: true
  
  # Each queue type runs as a separate deployment
  workers:
    alliance:
      enabled: true
      replicaCount: 1
      concurrency: 5
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    
    auth:
      enabled: true
      replicaCount: 1
      concurrency: 10
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    
    character:
      enabled: true
      replicaCount: 2
      concurrency: 10
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    
    corporation:
      enabled: true
      replicaCount: 1
      concurrency: 5
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
    
    killmail:
      enabled: true
      replicaCount: 3
      concurrency: 20
      resources:
        requests:
          cpu: 200m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 512Mi
    
    price:
      enabled: true
      replicaCount: 1
      concurrency: 5
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 300m
          memory: 256Mi

# Cronjob workers
cronjobs:
  enabled: true
  replicaCount: 1
  
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# WebSocket listener
websocket:
  enabled: true
  replicaCount: 1
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Redis (Bitnami chart dependency)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: ""  # Will be auto-generated if empty
  master:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# Ingress configuration (using Nginx Ingress)
ingress:
  enabled: true
  className: nginx
  
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  
  hosts:
    - host: eve-kill.com
      paths:
        - path: /
          pathType: Prefix
  
  tls:
    - secretName: edk-tls
      hosts:
        - eve-kill.com

# CloudNativePG Database
database:
  # Create the PostgreSQL cluster as part of this chart
  createCluster: true
  
  # Cluster configuration
  clusterName: postgres
  imageName: ghcr.io/cloudnative-pg/postgresql:17.2
  instances: 3
  
  # Database and user
  database: evekill
  owner: evekill
  
  # Secret for credentials (will be created by chart)
  secretName: postgres-app-credentials
  password: "changeme-evekill-password"  # CHANGE THIS IN PRODUCTION
  
  # PostgreSQL parameters (high-performance tuning)
  parameters:
    max_connections: "300"
    shared_buffers: "8GB"
    effective_cache_size: "24GB"
    maintenance_work_mem: "2GB"
    checkpoint_completion_target: "0.9"
    wal_buffers: "16MB"
    default_statistics_target: "100"
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    max_locks_per_transaction: "1024"
    default_toast_compression: "lz4"
    work_mem: "27MB"
    min_wal_size: "2GB"
    max_wal_size: "8GB"
  
  # Storage configuration
  storage:
    storageClass: longhorn
    size: 200Gi
  
  walStorage:
    storageClass: longhorn
    size: 20Gi
  
  # Resources
  resources:
    requests:
      memory: "10Gi"
      cpu: "2000m"
    limits:
      memory: "32Gi"
      cpu: "14000m"
  
  # Monitoring
  monitoring:
    enablePodMonitor: true
  
  # High availability
  affinity:
    enablePodAntiAffinity: true
    podAntiAffinityType: "preferred"
  
  # Update strategy
  primaryUpdateStrategy: unsupervised
  
  # Keel annotations for auto-updates
  annotations:
    keel.sh/policy: major
    keel.sh/trigger: poll
  
  # Connection pooling via PgBouncer (CNPG Pooler)
  pooler:
    enabled: true
    instances: 3
    poolMode: transaction  # transaction or session
    parameters:
      max_client_conn: "1000"
      default_pool_size: "25"

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000

# Security context for containers
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # Nitro needs to write to .output/cache

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}
